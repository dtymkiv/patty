<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Party Games Service</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/unique-names-generator@4.7.1/dist/index.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Base backgrounds that transition */
        body {
            background-color: #f9fafb;
            /* gray-50 */
            color: #111827;
            /* gray-900 */
            transition: background-color 0.3s, color 0.3s;
        }

        .dark body {
            background-color: #111827;
            /* gray-900 */
            color: #ffffff;
        }

        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.3s;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        @keyframes pulse-subtle {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.8;
                transform: scale(1.05);
            }
        }

        .animate-pulse-subtle {
            animation: pulse-subtle 3s infinite ease-in-out;
        }

        @keyframes bounce-subtle {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        .animate-bounce-subtle {
            animation: bounce-subtle 2s infinite ease-in-out;
        }

        /* Mobile Landscape Optimizations */
        @media (orientation: landscape) and (max-height: 500px) {
            #app {
                padding: 0 !important;
            }

            header {
                display: none !important;
            }

            .room-nav-row {
                display: none !important;
            }

            .room-view-container {
                padding: 0 !important;
                max-width: none !important;
                height: 100dvh !important;
            }

            .main-game-grid {
                flex-direction: row !important;
                gap: 0 !important;
                margin: 0 !important;
                height: 100% !important;
            }

            .game-area-container {
                flex: 1 !important;
                height: 100% !important;
                border-radius: 0 !important;
                border: none !important;
                box-shadow: none !important;
                background: transparent !important;
            }

            .game-area-inner {
                flex-direction: row !important;
                height: 100% !important;
            }

            .game-info-header {
                width: 90px !important;
                flex-direction: column !important;
                border: none !important;
                border-right: 1px solid rgba(0, 0, 0, 0.1) !important;
                padding: 10px 5px !important;
                border-radius: 0 !important;
                flex-shrink: 0 !important;
                justify-content: flex-start !important;
                gap: 10px !important;
            }

            .info-item-group {
                flex-direction: column !important;
                align-items: center !important;
                gap: 2px !important;
            }

            .info-separator {
                display: none !important;
            }

            .game-info-header .flex-1.text-center {
                flex: none !important;
                width: 100% !important;
            }

            .canvas-side-container {
                flex: 1 !important;
                height: 100% !important;
                padding: 0 !important;
                background: #fff !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }

            .canvas-side-container canvas {
                height: 100% !important;
                width: auto !important;
                max-width: none !important;
                border-radius: 0 !important;
                aspect-ratio: 4/3 !important;
            }

            .interaction-bar-container {
                width: 160px !important;
                flex-direction: column !important;
                border: none !important;
                border-left: 1px solid rgba(0, 0, 0, 0.1) !important;
                border-radius: 0 !important;
                padding: 10px 5px !important;
                flex-shrink: 0 !important;
                justify-content: center !important;
            }

            .interaction-bar-container .flex-wrap {
                flex-direction: column !important;
                gap: 5px !important;
                align-items: center !important;
            }

            .interaction-bar-container .flex-1.p-2\.5 {
                font-size: 14px !important;
            }

            .sidebar-chat-players {
                display: none !important;
            }

            /* Adjust drawing toolbar for vertical in landscape */
            .drawing-toolbar-inner {
                flex-direction: column !important;
                align-items: center !important;
                gap: 10px !important;
                width: 100% !important;
            }

            .color-palette-grid {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 5px !important;
            }

            .drawing-actions-group {
                border-left: none !important;
                border-top: 1px solid rgba(0, 0, 0, 0.1) !important;
                padding-top: 10px !important;
                padding-left: 0 !important;
                flex-direction: column !important;
                gap: 8px !important;
            }

            .interaction-bar-container button {
                width: 32px !important;
                height: 32px !important;
            }

            .color-palette-grid button {
                width: 28px !important;
                height: 28px !important;
            }

            .guess-input-group {
                flex-direction: column !important;
                gap: 8px !important;
                width: 100% !important;
            }

            .guess-input-group input {
                width: 100% !important;
                font-size: 14px !important;
                padding: 8px !important;
            }

            .guess-input-group button {
                width: 100% !important;
                height: 40px !important;
            }
        }
    </style>
    <script src="/static/game_host.js"></script>
</head>

<body :class="{ 'dark': isDarkMode }">
    <div id="app"
        class="h-[100dvh] flex flex-col items-center p-0 sm:p-4 bg-gray-50 dark:bg-gray-900 transition-colors duration-300 overflow-y-auto overflow-x-hidden"
        :class="{ 'p-0': isInputFocused && isMobileView }">
        <header v-show="!(isInputFocused && isMobileView)"
            class="w-full max-w-6xl flex justify-between items-center mb-2 sm:mb-4 mt-2 sm:mt-4 px-4 sm:px-4 shrink-0 mx-auto transition-all duration-300">
            <div class="flex items-center gap-3 sm:gap-4 overflow-visible">
                <img src="/static/logo_wide.svg" alt="Party Games"
                    class="block h-10 sm:h-12 w-auto drop-shadow-[0_2px_8px_rgba(234,81,40,0.35)]">
            </div>
            <div class="flex items-center gap-2 sm:gap-4">
                <div v-if="nickname"
                    class="text-xs sm:text-base text-gray-600 dark:text-gray-300 flex items-center gap-1.5 sm:gap-2">
                    <template v-if="isEditingNickname && view === 'lobby'">
                        <input v-model="nicknameInput" @keyup.enter="saveNickname" @keyup.esc="cancelEditingNickname"
                            type="text" maxlength="20"
                            class="text-sm px-2 py-1 rounded bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white border border-[#ea5128] focus:outline-none w-32">
                        <div class="flex items-center gap-1">
                            <button @click="saveNickname" class="text-green-500 hover:text-green-600 p-0.5">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                            <button @click="cancelEditingNickname" class="text-red-500 hover:text-red-600 p-0.5">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </template>
                    <template v-else>
                        <span class="whitespace-nowrap">Playing as:</span>
                        <div class="flex items-center gap-1">
                            <span
                                class="font-bold text-gray-900 dark:text-white truncate max-w-[100px] sm:max-w-none">{{
                                nickname }}</span>
                            <button v-if="view === 'lobby'" @click="startEditingNickname"
                                class="text-gray-400 hover:text-[#ea5128] transition-colors p-1 -m-1"
                                title="Edit Nickname">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 sm:h-4 sm:w-4"
                                    viewBox="0 0 20 20" fill="currentColor">
                                    <path
                                        d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                </svg>
                            </button>
                        </div>
                    </template>
                </div>
                <button @click="toggleTheme"
                    class="relative inline-flex h-6 w-11 sm:h-8 sm:w-14 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none bg-gray-200 dark:bg-gray-700 shadow-inner group"
                    :title="isDarkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'">
                    <span class="sr-only">Toggle theme</span>
                    <span aria-hidden="true" :class="isDarkMode ? 'translate-x-5 sm:translate-x-6' : 'translate-x-0'"
                        class="pointer-events-none flex items-center justify-center h-5 w-5 sm:h-7 sm:w-7 transform rounded-full bg-white dark:bg-gray-900 shadow-lg ring-0 transition duration-200 ease-in-out">
                        <!-- Sun icon -->
                        <svg v-if="!isDarkMode" xmlns="http://www.w3.org/2000/svg"
                            class="h-3 w-3 sm:h-4 sm:w-4 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M10 1a1 1 0 011 1v1a1 1 0 11-2 0V2a1 1 0 011-1zm4.243 1.757a1 1 0 010 1.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 0zM19 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zm-4.757 4.243a1 1 0 01-1.414 0l-.707-.707a1 1 0 111.414-1.414l.707.707a1 1 0 010 1.414zM10 19a1 1 0 01-1-1v-1a1 1 0 112 0v1a1 1 0 01-1 1zm-4.243-1.757a1 1 0 010-1.414l.707-.707a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414 0zM1 10a1 1 0 011-1h1a1 1 0 110 2H2a1 1 0 01-1-1zm1.757-4.243a1 1 0 011.414 0l.707.707a1 1 0 11-1.414 1.414l-.707-.707a1 1 0 010-1.414zM10 14a4 4 0 100-8 4 4 0 000 8z"
                                clip-rule="evenodd" />
                        </svg>
                        <!-- Moon icon -->
                        <svg v-else xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 sm:h-4 sm:w-4 text-blue-400"
                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                    </span>
                </button>
            </div>
        </header>

        <!-- View: Login -->
        <transition name="fade" mode="out-in">
            <div v-if="view === 'login'"
                class="bg-white dark:bg-gray-800 p-10 rounded-3xl shadow-2xl w-full max-w-lg flex flex-col items-center border border-gray-200 dark:border-gray-700/50 transition-colors duration-300">
                <img src="/static/logo.svg" alt="Logo"
                    class="h-24 w-auto mb-8 drop-shadow-[0_8px_20px_rgba(234,81,40,0.25)] animate-pulse-subtle">
                <h2 class="text-3xl mb-8 font-black w-full text-center text-gray-900 dark:text-gray-100">Enter Nickname
                </h2>
                <div class="w-full mb-4">
                    <input v-model="nicknameInput" @keyup.enter="setNickname" type="text"
                        placeholder="Your cool nickname..." maxlength="20"
                        class="w-full p-3 rounded bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-[#ea5128] transition-colors duration-300">
                    <button @click="generateRandomName" type="button"
                        class="w-full mt-2 text-sm text-gray-500 dark:text-gray-400 hover:text-[#ea5128] dark:hover:text-[#ea5128] font-bold transition-colors flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"
                                clip-rule="evenodd" />
                        </svg>
                        Generate random name
                    </button>
                </div>
                <button @click="setNickname"
                    class="w-full bg-[#ea5128] hover:bg-[#c1381b] text-white font-bold py-3 rounded-xl transition shadow-lg hover:shadow-xl active:scale-95">Enter
                    Lobby</button>
            </div><!-- -->
            <div v-else-if="view === 'lobby'"
                class="w-full max-w-4xl px-4 sm:px-4 grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-8 mx-auto shrink-0 pb-8">

                <!-- Join Room by Code -->
                <div
                    class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 transition-colors duration-300 flex flex-col items-center justify-center text-center">
                    <h2 class="text-2xl font-black text-gray-900 dark:text-gray-100 mb-6">Join with Code</h2>
                    <div class="flex flex-col w-full max-w-xs gap-4">
                        <input v-model="joinCodeInput" type="text" placeholder="123456" maxlength="6"
                            class="text-center text-3xl tracking-[0.5em] font-mono p-4 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white border border-gray-200 dark:border-transparent focus:outline-none focus:ring-4 focus:ring-[#ea5128] uppercase transition-all">
                        <button @click="joinRoomByCode" :disabled="joinCodeInput.length !== 6"
                            class="w-full bg-[#ea5128] hover:bg-[#c1381b] text-white font-black py-4 rounded-xl transition-all shadow-lg hover:shadow-[#ea512833] active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                            JOIN GAME
                        </button>
                    </div>
                </div>

                <!-- Create Room -->
                <div
                    class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 transition-colors duration-300 text-center flex flex-col items-center justify-center">
                    <h2 class="text-2xl font-black text-gray-900 dark:text-gray-100 mb-2">Host a Game</h2>
                    <p class="text-gray-500 dark:text-gray-400 mb-8 font-medium italic">
                        Start a new room and share the 6-digit code with your friends.
                    </p>

                    <button @click="createRoom"
                        class="w-full bg-green-500 hover:bg-green-600 text-white font-black py-4 rounded-xl transition-all shadow-lg hover:shadow-green-500/20 active:scale-95 uppercase tracking-widest text-sm">
                        CREATE NEW GAME
                    </button>
                </div>
            </div><!-- -->
            <div v-else-if="view === 'room'"
                class="room-view-container w-full max-w-6xl flex-1 flex flex-col container mx-auto px-4 sm:px-4 transition-all duration-300 pb-8"
                :class="{ 'pt-0': isInputFocused && isMobileView }">
                <div v-show="!(isInputFocused && isMobileView)"
                    class="room-nav-row px-0 mb-2 sm:mb-4 mt-2 sm:mt-0 flex justify-between items-center shrink-0 transition-all duration-300">
                    <div class="flex flex-col">
                        <button @click="handleLeaveRequest"
                            class="text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors flex items-center gap-1 sm:gap-2 font-bold whitespace-nowrap">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span class="text-sm sm:text-base">Leave</span>
                        </button>
                        <span class="text-xs text-gray-400 dark:text-gray-500 font-mono">Code: {{ roomCode }}</span>
                    </div>
                    <div class="flex gap-2 sm:gap-4">
                        <div v-if="gameState === 'lobby'" class="flex gap-2 sm:gap-4">
                            <button @click="openInviteModal"
                                class="bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 px-3 sm:px-6 py-2 rounded-xl font-black text-white transition-all shadow-md active:scale-95 whitespace-nowrap text-sm sm:text-base flex items-center gap-1.5 sm:gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5"
                                    viewBox="0 0 20 20" fill="currentColor">
                                    <path
                                        d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" />
                                </svg>
                            </button>
                            <button @click="toggleReady"
                                :class="amIReady ? 'bg-gray-400 dark:bg-gray-600 hover:bg-gray-500' : 'bg-[#ea5128] hover:bg-[#c1381b]'"
                                class="px-3 sm:px-6 py-2 rounded-xl font-black text-white transition-all shadow-md active:scale-95 whitespace-nowrap text-sm sm:text-base">
                                {{ amIReady ? 'Unready' : 'Ready' }}
                            </button>
                            <button v-if="amIHost" @click="startGame" :disabled="!canStart"
                                :class="canStart ? 'bg-yellow-500 hover:bg-yellow-400 text-black' : 'bg-gray-200 dark:bg-gray-700 text-gray-400 dark:text-gray-500 cursor-not-allowed'"
                                class="px-3 sm:px-6 py-2 rounded-xl font-black transition-all shadow-md whitespace-nowrap text-sm sm:text-base">
                                Start Game
                            </button>
                        </div>
                        <div v-else class="text-[#ea5128] font-black text-xl animate-pulse tracking-widest uppercase">
                            Live!
                        </div>
                    </div>
                </div>
                <div
                    class="main-game-grid flex-1 flex flex-col lg:grid lg:grid-cols-4 gap-2 sm:gap-4 min-h-0 mb-0 sm:mb-4">
                    <!-- Main: Game Area (Canvas/Config) -->
                    <div
                        class="game-area-container order-1 lg:order-none lg:col-span-2 flex flex-col shrink-0 lg:shrink bg-white dark:bg-gray-900 sm:rounded-2xl border-0 sm:border border-gray-200 dark:border-gray-700 relative shadow-xl transition-colors duration-300 min-h-0">
                        <div v-if="gameState === 'lobby'" class="w-full max-w-2xl px-6 py-10 h-fit mx-auto">
                            <h3 class="text-3xl font-black mb-10 text-center text-[#ea5128] uppercase tracking-wider">
                                Settings</h3>

                            <div class="space-y-8">
                                <!-- Host Role -->
                                <div>
                                    <label
                                        class="block text-gray-600 dark:text-gray-400 font-bold uppercase text-xs tracking-widest mb-2">Host
                                        Role</label>
                                    <div class="flex gap-4">
                                        <button @click="setHostRole('player')" :disabled="!amIHost"
                                            :class="gameConfig.host_role === 'player' ? 'bg-[#ea5128] text-white shadow-[#ea512833]' : 'bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 border border-transparent'"
                                            class="flex-1 py-3 rounded-xl transition-all border border-transparent shadow-lg active:scale-95 font-bold">
                                            Player
                                        </button>
                                        <button @click="setHostRole('spectator')" :disabled="!amIHost"
                                            :class="gameConfig.host_role === 'spectator' ? 'bg-[#ea5128] text-white shadow-[#ea512833]' : 'bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 border border-transparent'"
                                            class="flex-1 py-3 rounded-xl transition-all border border-transparent shadow-lg active:scale-95 font-bold">
                                            Spectator
                                        </button>
                                    </div>
                                </div>

                                <!-- Round Duration -->
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <label
                                            class="text-gray-600 dark:text-gray-400 font-bold uppercase text-xs tracking-widest">Round
                                            Duration</label>
                                        <span class="text-[#ea5128] font-black">{{ gameConfig.round_duration
                                            }}s</span>
                                    </div>
                                    <input type="range" min="30" max="180" step="10"
                                        v-model.number="gameConfig.round_duration" @input="updateConfig"
                                        :disabled="!amIHost"
                                        class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer accent-[#ea5128]">
                                </div>

                                <!-- Points to Win -->
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <label
                                            class="text-gray-600 dark:text-gray-400 font-bold uppercase text-xs tracking-widest">Points
                                            to Win</label>
                                        <span class="text-[#ea5128] font-black">{{ gameConfig.points_to_win
                                            }}</span>
                                    </div>
                                    <input type="range" min="5" max="250" step="5"
                                        v-model.number="gameConfig.points_to_win" @input="updateConfig"
                                        :disabled="!amIHost"
                                        class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer accent-[#ea5128]">
                                </div>

                                <!-- Base Points -->
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <label
                                            class="text-gray-600 dark:text-gray-400 font-bold uppercase text-xs tracking-widest">Base
                                            Points (First Guess)</label>
                                        <span class="text-[#ea5128] font-black">{{ gameConfig.base_points || 10
                                            }}</span>
                                    </div>
                                    <input type="range" min="1" :max="gameConfig.points_to_win" step="1"
                                        v-model.number="gameConfig.base_points" @input="updateConfig"
                                        :disabled="!amIHost"
                                        class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer accent-[#ea5128]">
                                </div>

                                <!-- Turn Order -->
                                <div>
                                    <label
                                        class="block text-gray-600 dark:text-gray-400 font-bold uppercase text-xs tracking-widest mb-2">Turn
                                        Order</label>
                                    <div class="flex gap-4">
                                        <button @click="setTurnOrder('sequence')" :disabled="!amIHost"
                                            :class="gameConfig.turn_order === 'sequence' ? 'bg-[#ea5128] text-white shadow-[#ea512833]' : 'bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 border border-transparent'"
                                            class="flex-1 py-3 rounded-xl transition-all border border-transparent shadow-lg active:scale-95 font-bold">
                                            Sequential
                                        </button>
                                        <button @click="setTurnOrder('winner')" :disabled="!amIHost"
                                            :class="gameConfig.turn_order === 'winner' ? 'bg-[#ea5128] text-white shadow-[#ea512833]' : 'bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 border border-transparent'"
                                            class="flex-1 py-3 rounded-xl transition-all border border-transparent shadow-lg active:scale-95 font-bold">
                                            Winner First
                                        </button>
                                    </div>
                                </div>

                                <!-- Word Language & Difficulty -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label
                                            class="block text-gray-600 dark:text-gray-400 font-bold uppercase text-[10px] tracking-widest mb-1.5">Language</label>
                                        <select v-model="gameConfig.word_language" @change="updateConfig"
                                            :disabled="!amIHost"
                                            class="w-full p-2.5 rounded-xl bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white border border-gray-200 dark:border-transparent focus:outline-none focus:ring-2 focus:ring-[#ea5128] transition-colors duration-300 text-sm">
                                            <option v-for="(label, lang) in wordSetMetadata.languages" :key="lang"
                                                :value="lang">{{ label }}</option>
                                        </select>
                                    </div>

                                    <div v-if="availableDifficulties.length > 0">
                                        <label
                                            class="block text-gray-600 dark:text-gray-400 font-bold uppercase text-[10px] tracking-widest mb-1.5">Difficulty</label>
                                        <select v-model="gameConfig.word_difficulty" @change="updateConfig"
                                            :disabled="!amIHost"
                                            class="w-full p-2.5 rounded-xl bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white border border-gray-200 dark:border-transparent focus:outline-none focus:ring-2 focus:ring-[#ea5128] transition-colors duration-300 text-sm">
                                            <option v-for="d in availableDifficulties" :key="d" :value="d">{{ d }}
                                            </option>
                                        </select>
                                    </div>
                                </div>

                            </div>

                            <p v-if="!amIHost" class="mt-8 text-center text-gray-500 text-sm italic">Only the host
                                can
                                change settings.</p>
                        </div>

                        <div v-else
                            class="game-area-inner w-full h-full flex flex-col relative text-gray-900 dark:text-white">
                            <!-- Condensed Game Header -->
                            <div
                                class="game-info-header flex items-center justify-between px-2 py-2 border-b border-gray-100 dark:border-gray-800 bg-gray-50/50 dark:bg-gray-800/50 rounded-t-2xl shrink-0 gap-2 sm:px-4 sm:py-2 sm:gap-4">
                                <div class="flex flex-col items-center leading-none">
                                    <div class="flex items-center gap-0.5 mb-0.5">
                                        <span
                                            class="text-[10px] text-gray-400 dark:text-gray-500 uppercase font-black">â„–</span>
                                        <span class="font-black text-xs text-gray-700 dark:text-white leading-none">{{
                                            gameStateData.round }}</span>
                                    </div>
                                    <div v-if="gameStateData.phase === 'DRAWING'"
                                        class="text-[9px] font-black text-[#ea5128] leading-none">
                                        {{ gameStateData.correct_guessers.length }}/{{ totalGuessers }}
                                    </div>
                                    <div v-else
                                        class="text-[9px] font-bold text-gray-400 dark:text-gray-600 leading-none">
                                        &mdash;
                                    </div>
                                </div>
                                <div class="info-separator h-8 w-px bg-gray-200 dark:bg-gray-700"></div>
                                <div class="flex items-center gap-1.5 timer-display">
                                    <span class="text-2xl font-black font-mono"
                                        :class="timeLeft < 10 && gameStateData.phase === 'DRAWING' ? 'text-red-500' : 'text-gray-900 dark:text-white'">
                                        {{ gameStateData.phase === 'DRAWING' ? timeLeft + 's' : '?' }}
                                    </span>
                                </div>

                                <div class="flex-1 text-center min-w-0 py-1">
                                    <div v-if="amIDrawing"
                                        class="font-black text-green-600 dark:text-green-400 tracking-wider flex flex-wrap justify-center gap-x-1"
                                        :style="{ fontSize: dynamicFontSize + 'px' }">
                                        {{ gameStateData.word }}
                                    </div>
                                    <div v-else class="flex flex-wrap justify-center gap-x-2 gap-y-1 px-2">
                                        <div v-for="(wordGroup, gIdx) in (gameStateData.word_hints || '').split(' ')"
                                            :key="gIdx" class="flex gap-x-0.5">
                                            <span v-for="(char, cIdx) in wordGroup" :key="cIdx"
                                                class="font-black text-gray-700 dark:text-gray-300 border-b-2 border-gray-300 dark:border-gray-700 flex items-center justify-center"
                                                :style="hintCharStyle">
                                                {{ char === '_' ? '' : char }}
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex items-center justify-end text-[10px] sm:text-xs">
                                    <div v-if="amIDrawing"
                                        class="text-green-600 dark:text-green-400 font-black uppercase tracking-widest bg-green-500/10 px-2 py-1 rounded-lg border border-green-500/20">
                                        Drawing
                                    </div>
                                    <div v-else
                                        class="text-[#ea5128] font-black uppercase tracking-widest bg-[#ea5128]/10 px-2 py-1 rounded-lg border border-[#ea5128]/20 truncate max-w-[80px] sm:max-w-[120px]"
                                        :title="gameStateData.drawer">
                                        {{ gameStateData.drawer }}
                                    </div>
                                </div>
                            </div>

                            <!-- START ROUND BUTTON (DRAWER ONLY) -->
                            <div v-if="amIDrawing && gameStateData.phase === 'DRAWER_PREPARING'"
                                class="absolute inset-0 z-20 flex items-center justify-center bg-black/40 rounded-lg">
                                <button @click="startActiveRound"
                                    class="bg-green-600 hover:bg-green-500 text-white text-2xl font-bold py-6 px-12 rounded-xl shadow-2xl transform hover:scale-105 transition-all">
                                    START ROUND!
                                </button>
                            </div>

                            <!-- Canvas Area -->
                            <div class="canvas-side-container w-full flex-1 relative bg-white dark:bg-white rounded-b-xl shadow-inner overflow-hidden min-h-0 flex items-center justify-center p-0 sm:p-2 transition-all duration-300 border-4"
                                :class="{ 'shake-error border-red-500': isShaking, 'success-border border-green-500': hasGuessed, 'border-transparent': !isShaking && !hasGuessed }"
                                id="canvas-container">
                                <canvas ref="gameCanvas"
                                    class="w-full max-h-full block cursor-crosshair touch-none h-auto"
                                    style="aspect-ratio: 4/3;"></canvas>
                            </div>

                            <!-- Interaction Bar (Toolbar for Drawer OR Chat Input for Guesser) -->
                            <div
                                class="interaction-bar-container bg-white dark:bg-gray-800 p-2 sm:p-3 border-t border-gray-100 dark:border-gray-700 shadow-lg shrink-0 sm:rounded-b-2xl">
                                <!-- Drawing Toolbar (Drawer Only) -->
                                <div v-if="amIDrawing && gameStateData.phase !== 'POST_ROUND' && gameStateData.phase !== 'GAME_OVER'"
                                    class="drawing-toolbar-inner flex items-center justify-between gap-2 max-w-full transition-colors duration-300"
                                    style="--total-buttons: 10; --gap-size: 0.25rem;">
                                    <div
                                        class="color-palette-grid flex flex-nowrap gap-1 justify-center flex-1 min-w-0 items-center">
                                        <template v-for="c in drawColors" :key="c">
                                            <button @click="setBrushColor(c)" :style="{backgroundColor: c}"
                                                class="color-btn rounded-xl border-2 border-white dark:border-gray-900 hover:scale-110 transition-all shadow-lg active:scale-90 aspect-square flex-shrink"
                                                :class="{'ring-4 ring-[#ea5128]': currentBrushColor === c && !isEraser}"></button>
                                        </template>
                                        <button @click="toggleEraser" title="Eraser"
                                            class="color-btn flex items-center justify-center bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-xl text-gray-700 dark:text-gray-300 transition-all active:scale-90 shadow-lg flex-shrink aspect-square"
                                            :class="{'ring-4 ring-[#ea5128] bg-gray-200 dark:bg-gray-600': isEraser}">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-full h-full p-1.5" fill="currentColor" viewBox="0 0 16 16">
                                                <path d="M8.086 2.207a2 2 0 0 1 2.828 0l3.879 3.879a2 2 0 0 1 0 2.828l-5.5 5.5A2 2 0 0 1 7.879 15H5.12a2 2 0 0 1-1.414-.586l-2.5-2.5a2 2 0 0 1 0-2.828zm2.121.707a1 1 0 0 0-1.414 0L4.16 7.547l5.293 5.293 4.633-4.633a1 1 0 0 0 0-1.414zM8.746 13.547 3.453 8.254 1.914 9.793a1 1 0 0 0 0 1.414l2.5 2.5a1 1 0 0 0 .707.293H7.88a1 1 0 0 0 .707-.293z"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <div
                                        class="drawing-actions-group flex items-center gap-1.5 pl-2 border-l border-gray-100 dark:border-gray-700 shrink-0">
                                        <button @click="undoStroke" title="Undo last stroke"
                                            class="color-btn action-btn flex items-center justify-center bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 transition-all active:scale-90 shadow-lg aspect-square">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-full h-full p-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                                            </svg>
                                        </button>
                                        <button @click="clearCanvas" title="Clear all drawings"
                                            class="color-btn action-btn flex items-center justify-center bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 transition-all active:scale-90 shadow-lg aspect-square">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-full h-full p-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                                <!-- Chat Input (Lobby or Guess Input during game) -->
                                <div v-if="(gameState === 'lobby' || (!amIDrawing && gameStateData.phase !== 'POST_ROUND' && gameStateData.phase !== 'GAME_OVER' && gameStateData.phase !== 'DRAWER_PREPARING'))"
                                    class="guess-input-group flex gap-2">
                                    <input v-model="chatInput" @keyup.enter="sendChat" type="text"
                                        @focus="handleInputFocus" @blur="handleInputBlur"
                                        :disabled="hasGuessed && gameStateData.phase === 'DRAWING'"
                                        :placeholder="gameState === 'lobby' ? 'Type a message...' : (amIHost && gameConfig.host_role === 'spectator' ? 'Type a message...' : (hasGuessed ? 'You guessed correctly!' : 'Type a guess...'))"
                                        class="flex-1 p-2.5 rounded-xl bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white border border-gray-200 dark:border-transparent focus:outline-none focus:ring-2 focus:ring-[#ea5128] disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300">
                                    <button v-if="!isMobileView" @click="sendChat" @mousedown.prevent
                                        :disabled="hasGuessed && gameStateData.phase === 'DRAWING'"
                                        class="bg-[#ea5128] hover:bg-[#c1381b] text-white px-4 py-2 rounded-xl font-bold transition-all active:scale-95 disabled:opacity-50">
                                        Send
                                    </button>
                                </div>

                                <!-- Generic Info (Phase transitions) -->
                                <div v-if="gameStateData.phase === 'POST_ROUND' || gameStateData.phase === 'GAME_OVER' || gameStateData.phase === 'DRAWER_PREPARING'"
                                    class="text-center py-2 text-sm font-bold text-gray-500">
                                    Round processing...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar: Chat & Players Container -->
                    <div
                        class="sidebar-chat-players order-2 lg:order-none flex flex-col lg:grid lg:grid-cols-1 gap-2 sm:gap-4 flex-1 min-h-0 lg:col-span-2">
                        <div class="flex flex-col lg:flex-row gap-2 sm:gap-4 flex-1 min-h-0">
                            <!-- Sidebar: Chat -->
                            <div
                                class="bg-white dark:bg-gray-800 p-2 sm:p-4 rounded-xl sm:rounded-2xl flex flex-col h-[100px] lg:h-auto lg:min-h-0 flex-none lg:flex-1 border border-gray-200 dark:border-gray-700 shadow-xl transition-colors duration-300 mt-2 sm:mt-0 mx-2 sm:mx-0">
                                <h3
                                    class="font-black mb-1 sm:mb-3 text-gray-400 dark:text-gray-500 uppercase text-[10px] tracking-widest shrink-0">
                                    Chat</h3>
                                <div class="flex-1 overflow-y-auto bg-gray-50 dark:bg-gray-900/50 rounded-xl p-2 mb-0 space-y-1.5 border border-gray-100 dark:border-transparent shadow-inner"
                                    id="chat-box">
                                    <div v-for="(msg, i) in displayedMessages" :key="i" class="text-sm">
                                        <span :style="{color: msg.color}" class="font-black">{{ msg.sender
                                            }}:</span>
                                        <span class="text-gray-700 dark:text-gray-200 ml-1 font-medium">{{ msg.text
                                            }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Sidebar: Players -->
                            <div
                                class="bg-white dark:bg-gray-800 p-2 sm:p-4 rounded-xl sm:rounded-2xl flex flex-col min-h-[150px] lg:min-h-0 flex-1 border border-gray-200 dark:border-gray-700 shadow-xl transition-colors duration-300 mx-2 sm:mx-0 mb-4 sm:mb-0">
                                <h3
                                    class="font-black mb-1 sm:mb-3 text-gray-400 dark:text-gray-500 uppercase text-[10px] tracking-widest shrink-0">
                                    Players ({{ players.length }})</h3>
                                <ul class="space-y-1.5 overflow-y-auto flex-1 pr-1">
                                    <li v-for="p in players" :key="p.nickname"
                                        class="flex items-center justify-between bg-gray-50 dark:bg-gray-700 p-2 rounded-xl transition-all duration-300 border-2 border-transparent"
                                        :class="{
                                            'opacity-60': !p.connected,
                                            'opacity-40': p.is_spectator,
                                            'border-green-500 shadow-lg shadow-green-500/30': p.has_guessed_correctly && gameStateData.phase === 'DRAWING',
                                            'animate-player-shake border-red-500 shadow-lg shadow-red-500/30': playersWithIncorrectGuess.has(p.nickname) && gameStateData.phase === 'DRAWING',
                                            'border-yellow-500/50 shadow-lg': p.nickname === gameStateData.drawer && gameStateData.phase === 'DRAWING'
                                        }">
                                        <div class="flex items-center gap-2">
                                            <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm text-white relative shadow-md"
                                                :style="{backgroundColor: p.color, opacity: p.is_spectator ? 0.5 : 1}">
                                                {{ p.nickname[0] }}
                                                <span v-if="p.is_host"
                                                    class="absolute -top-1 -right-1 text-xs">ðŸ‘‘</span>
                                            </div>
                                            <span class="truncate max-w-[100px] font-bold" :style="{color: p.color, opacity: p.is_spectator ? 0.5 : 1}">{{
                                                p.nickname }}</span><span v-if="p.nickname === nickname" class="text-xs text-gray-500 dark:text-gray-400 italic font-bold ml-1 flex-shrink-0">(you)</span>
                                        </div>

                                        <div class="flex items-center gap-2">
                                            <span v-if="gameState !== 'lobby'" class="text-sm font-black text-yellow-500">{{ p.score || 0
                                                }}</span>
                                            <!-- Show ready checkmark only in lobby -->
                                            <span v-if="gameState === 'lobby' && p.is_ready"
                                                class="text-green-500 text-xl">âœ“</span>
                                            <!-- Show disconnected icon when player is disconnected -->
                                            <span v-if="!p.connected"
                                                class="text-red-500 text-xs" title="Disconnected">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.464-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414" />
                                                </svg>
                                            </span>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </transition>

        <!-- Host Disconnected Modal -->
        <div v-if="isHostDisconnected"
            class="fixed inset-0 z-[80] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
            <div
                class="bg-gray-900 text-white rounded-3xl p-8 max-w-md w-full text-center border border-gray-700 shadow-2xl animate-pulse">
                <div class="mb-6 text-yellow-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="text-3xl font-black mb-4 uppercase tracking-wider">Game Paused</h3>
                <p class="text-gray-300 text-lg mb-8">
                    The Host has disconnected. Waiting for them to reconnect...
                </p>
                <div class="w-full h-1 bg-gray-800 rounded-full overflow-hidden">
                    <div class="h-full bg-yellow-500 animate-progress"></div>
                </div>
            </div>
        </div>

        <!-- Overlay: Game Over (ðŸ† Trophy Overlay) -->
        <div v-if="gameStateData.phase === 'GAME_OVER'"
            class="fixed inset-0 bg-gray-900/40 dark:bg-black/80 backdrop-blur-md flex flex-col items-center justify-center z-[60] text-center p-4">
            <h2
                class="text-5xl font-black text-gray-900 dark:text-white mb-2 drop-shadow-lg uppercase tracking-tighter">
                GAME OVER!</h2>
            <p class="text-xl text-gray-600 dark:text-gray-300 mb-6 font-bold uppercase tracking-widest">The
                word was: <span class="text-green-600 dark:text-green-400 font-black">{{
                    gameStateData.word }}</span></p>

            <div
                class="bg-white dark:bg-gray-800 p-8 rounded-3xl w-full max-w-sm shadow-2xl border border-gray-100 dark:border-gray-700 overflow-y-auto max-h-[90vh]">
                <!-- Winner Banner -->
                <div v-if="sortedPlayers.length > 0"
                    class="mb-8 text-center bg-yellow-50 dark:bg-yellow-500/10 p-4 rounded-2xl border-2 border-yellow-200 dark:border-yellow-500/20">
                    <div
                        class="text-[10px] text-yellow-600 dark:text-yellow-400 font-black uppercase tracking-widest mb-1">
                        Winner
                    </div>
                    <div
                        class="text-4xl font-black text-yellow-600 dark:text-yellow-400 flex items-center justify-center gap-3">
                        <span>ðŸ†</span> {{ sortedPlayers[0].nickname }}
                    </div>
                    <div class="text-gray-700 dark:text-white font-black mt-1 text-xl">{{
                        sortedPlayers[0].score
                        }} pts</div>
                </div>

                <h3 class="text-gray-400 dark:text-gray-500 text-[10px] font-black uppercase tracking-widest mb-4">
                    Leaderboard</h3>
                <ul class="space-y-2">
                    <li v-for="(p, idx) in sortedPlayers" :key="p.nickname"
                        class="flex justify-between items-center p-3 rounded-xl bg-gray-50 dark:bg-gray-700/50 border border-transparent"
                        :class="idx === 0 ? 'border-yellow-500/50 bg-yellow-50/50 dark:bg-gray-700/80' : ''">
                        <div class="flex items-center gap-3">
                            <span class="font-mono text-gray-400 dark:text-gray-500 w-4 text-right font-bold">{{
                                idx + 1
                                }}</span>
                            <span
                                :class="idx === 0 ? 'font-black text-gray-900 dark:text-white' : 'text-gray-700 dark:text-gray-300 font-bold'">{{
                                p.nickname }}<span v-if="p.nickname === nickname" class="text-xs text-gray-500 dark:text-gray-400 italic font-bold ml-1">(you)</span></span>
                        </div>
                        <span class="font-black"
                            :class="idx === 0 ? 'text-yellow-600 dark:text-yellow-400' : 'text-gray-400 dark:text-gray-400'">{{
                            p.score
                            }}</span>
                    </li>
                </ul>
                <button v-if="amIHost" @click="startGame"
                    class="mt-8 w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl shadow-xl hover:shadow-blue-500/20 transition-all active:scale-95 text-lg">
                    Play Again
                </button>
                <button @click="handleLeaveRequest"
                    class="mt-4 w-full text-gray-400 dark:text-gray-500 hover:text-red-500 dark:hover:text-red-400 font-bold py-2 transition-colors text-sm uppercase tracking-widest">
                    Leave Room
                </button>
            </div>
        </div>

        <!-- Results Modal (Animated Bars for DRAWER_PREPARING) -->
        <div v-if="gameStateData.phase === 'DRAWER_PREPARING'"
            class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900/40 dark:bg-black/80 backdrop-blur-md p-4">
            <div
                class="bg-white dark:bg-gray-800 w-full max-w-2xl rounded-3xl shadow-2xl border border-gray-100 dark:border-gray-700 overflow-hidden transform transition-all">
                <div
                    class="p-4 border-b border-gray-100 dark:border-gray-700 flex items-start gap-4 bg-gray-50 dark:bg-gray-900/50">
                    <button @click="handleLeaveRequest"
                        class="text-gray-400 hover:text-red-500 transition-colors p-1.5 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transform -scale-x-100 mt-1"
                        title="Leave Room">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                    </button>
                    <div class="flex-1">
                        <h2
                            class="text-2xl font-black text-gray-900 dark:text-white uppercase tracking-wider leading-none">
                            Next Up: <span class="text-[#ea5128]">{{ gameStateData.drawer }}</span>
                        </h2>
                        <p v-if="gameStateData.phase === 'DRAWER_PREPARING' && gameStateData.last_drawer"
                            class="text-[#ea5128] text-sm font-bold flex items-center gap-1 mt-1">
                            <span class="text-gray-500 dark:text-gray-400">{{ gameStateData.last_drawer
                                }}</span> was drawing
                            <span
                                class="text-gray-900 dark:text-white uppercase tracking-widest px-2 py-0.5 bg-gray-100 dark:bg-gray-700 rounded">{{
                                gameStateData.last_word }}</span>
                        </p>
                    </div>
                </div>

                <div class="results-list-container p-4 space-y-2 max-h-[50vh] overflow-y-auto bg-white dark:bg-gray-800">
                    <transition-group name="results-list" tag="div" class="space-y-2">
                        <div v-for="(res, idx) in animatedResults" :key="res.nickname"
                            class="relative flex items-center gap-3 p-2.5 bg-gray-50 dark:bg-gray-700/40 rounded-xl border-2 transition-all duration-500 animate-slide-in"
                            :class="res.nickname === gameStateData.last_drawer ? 'border-yellow-500/50 shadow-lg' : 'border-transparent'"
                            :style="{ animationDelay: (idx * 0.1) + 's' }">

                            <div class="w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center text-base font-black text-white shadow-xl relative"
                                :style="{ backgroundColor: getPlayerColor(res.nickname) }">
                                {{ res.nickname[0] }}
                                <!-- Rank Badge -->
                                <div v-if="getRank(res.nickname)"
                                    class="absolute -top-1.5 -left-1.5 w-5 h-5 bg-yellow-500 rounded-full flex items-center justify-center text-[9px] text-black font-black border-2 border-white dark:border-gray-800 shadow-md">
                                    #{{ getRank(res.nickname) }}
                                </div>
                            </div>

                            <div class="flex-1">
                                <div class="flex justify-between items-end mb-0.5">
                                    <span class="font-black text-gray-800 dark:text-gray-200 text-base">{{
                                        res.nickname }} <span v-if="res.nickname === nickname"
                                            class="text-xs text-gray-500 dark:text-gray-400 italic font-bold">(you)</span><span v-if="res.nickname === gameStateData.last_drawer"
                                            class="text-xs text-[#ea5128] italic font-bold">(Drawer)</span></span>
                                    <span v-if="gameStateData.last_drawer"
                                        class="text-green-600 dark:text-green-400 font-black text-xl animate-pulse">+{{
                                        res.points
                                        }}</span>
                                </div>
                                <div
                                    class="relative h-3 w-full bg-gray-200 dark:bg-gray-900 rounded-full overflow-hidden flex shadow-inner">
                                    <!-- Base Score Segment -->
                                    <div class="h-full bg-[#ea5128]/60 transition-all duration-500 ease-out"
                                        :style="{ width: getBaseScorePercentage(res.nickname) + '%' }">
                                    </div>
                                    <!-- New Points Segment -->
                                    <div class="h-full bg-[#ea5128] transition-all duration-500 ease-out fill-animation border-l border-white/20"
                                        :style="{ width: getNewPointsPercentage(res.nickname) + '%' }">
                                    </div>
                                </div>
                                <div class="flex justify-between mt-0.5">
                                    <span
                                        class="text-[10px] text-gray-500 dark:text-gray-400 font-black uppercase tracking-widest">Total:
                                        <span class="text-gray-900 dark:text-white">{{
                                            getBaseScore(res.nickname) +
                                            res.points }}</span></span>
                                    <span v-if="res.nickname === gameStateData.last_drawer"
                                        class="text-[9px] text-gray-400 italic">
                                        guessed in {{ res.time }}s
                                    </span>
                                    <span v-else-if="res.time"
                                        class="text-[9px] text-gray-400 italic font-bold">Guessed in
                                        {{
                                        res.time }}s</span>
                                </div>
                            </div>
                        </div>
                    </transition-group>
                </div>

                <!-- Sticky duplicate of current player's result -->
                <div v-if="myResultEntry && !(amIHost && gameConfig.host_role === 'spectator') && resultsListNeedsScroll"
                    class="sticky bottom-0 p-4 pt-0 bg-white dark:bg-gray-800 border-t-2 border-gray-200 dark:border-gray-700">
                    <div class="relative flex items-center gap-3 p-2.5 bg-gray-50 dark:bg-gray-700/40 rounded-xl border-2 border-yellow-500/50 shadow-lg">
                        <div class="w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center text-base font-black text-white shadow-xl relative"
                            :style="{ backgroundColor: getPlayerColor(myResultEntry.nickname) }">
                            {{ myResultEntry.nickname[0] }}
                            <!-- Rank Badge -->
                            <div v-if="getRank(myResultEntry.nickname)"
                                class="absolute -top-1.5 -left-1.5 w-5 h-5 bg-yellow-500 rounded-full flex items-center justify-center text-[9px] text-black font-black border-2 border-white dark:border-gray-800 shadow-md">
                                #{{ getRank(myResultEntry.nickname) }}
                            </div>
                        </div>

                        <div class="flex-1">
                            <div class="flex justify-between items-end mb-0.5">
                                <span class="font-black text-gray-800 dark:text-gray-200 text-base">{{
                                    myResultEntry.nickname }} <span class="text-xs text-gray-500 dark:text-gray-400 italic font-bold">(you)</span><span v-if="myResultEntry.nickname === gameStateData.last_drawer"
                                        class="text-xs text-[#ea5128] italic font-bold">(Drawer)</span></span>
                                <span v-if="gameStateData.last_drawer"
                                    class="text-green-600 dark:text-green-400 font-black text-xl animate-pulse">+{{
                                    myResultEntry.points
                                    }}</span>
                            </div>
                            <div
                                class="relative h-3 w-full bg-gray-200 dark:bg-gray-900 rounded-full overflow-hidden flex shadow-inner">
                                <!-- Base Score Segment -->
                                <div class="h-full bg-[#ea5128]/60 transition-all duration-500 ease-out"
                                    :style="{ width: getBaseScorePercentage(myResultEntry.nickname) + '%' }">
                                </div>
                                <!-- New Points Segment -->
                                <div class="h-full bg-[#ea5128] transition-all duration-500 ease-out fill-animation border-l border-white/20"
                                    :style="{ width: getNewPointsPercentage(myResultEntry.nickname) + '%' }">
                                </div>
                            </div>
                            <div class="flex justify-between mt-0.5">
                                <span
                                    class="text-[10px] text-gray-500 dark:text-gray-400 font-black uppercase tracking-widest">Total:
                                    <span class="text-gray-900 dark:text-white">{{
                                        getBaseScore(myResultEntry.nickname) +
                                        myResultEntry.points }}</span></span>
                                <span v-if="myResultEntry.nickname === gameStateData.last_drawer"
                                    class="text-[9px] text-gray-400 italic">
                                    guessed in {{ myResultEntry.time }}s
                                </span>
                                <span v-else-if="myResultEntry.time"
                                    class="text-[9px] text-gray-400 italic font-bold">Guessed in
                                    {{
                                    myResultEntry.time }}s</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-8 bg-gray-50 dark:bg-gray-900/50 text-center flex flex-col items-center gap-6">
                    <p v-if="gameStateData.phase === 'DRAWER_PREPARING' && amIDrawing"
                        class="text-gray-600 dark:text-gray-400 text-xs font-black uppercase tracking-[0.2em] mb-[-1rem]">
                        Your word is
                    </p>
                    <div v-if="gameStateData.phase === 'DRAWER_PREPARING' && amIDrawing"
                        class="text-4xl font-black text-[#ea5128] uppercase tracking-tighter mb-2">
                        {{ gameStateData.word }}
                    </div>

                    <div v-if="gameStateData.phase === 'DRAWER_PREPARING'" class="w-full">
                        <template v-if="amIDrawing">
                            <button @click="startActiveRound"
                                class="w-full py-5 bg-green-600 hover:bg-green-500 text-white rounded-2xl font-black text-2xl shadow-xl hover:shadow-green-500/20 transition-all animate-bounce-subtle">
                                START ROUND!
                            </button>
                        </template>
                        <template v-else>
                            <div
                                class="flex items-center justify-center gap-4 py-4 text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-lg">
                                <svg class="animate-spin h-6 w-6 text-[#ea5128]" xmlns="http://www.w3.org/2000/svg"
                                    fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                    </path>
                                </svg>
                                <span class="font-black uppercase tracking-widest text-sm">Wait for <span
                                        class="text-[#ea5128]">{{
                                        gameStateData.drawer }}</span></span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Invite Modal -->
        <div v-if="showInviteModal"
            class="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-gray-900/40 dark:bg-black/80 backdrop-blur-md">
            <div
                class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl p-8 max-w-md w-full animate-slide-in border border-gray-100 dark:border-gray-700 text-center">
                <div class="mb-4 text-blue-500 dark:text-blue-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                    </svg>
                </div>
                <h3 class="text-2xl font-black mb-2 text-gray-900 dark:text-white uppercase tracking-tight">Invite
                    Friends</h3>
                <p class="text-gray-600 dark:text-gray-300 mb-6 font-medium">
                    Share this link or QR code to invite players
                </p>

                <!-- QR Code Container -->
                <div class="mb-6 flex justify-center">
                    <div id="qrcode-container" class="bg-white p-4 rounded-xl shadow-inner"></div>
                </div>

                <!-- Invite Link -->
                <div class="mb-6">
                    <input v-model="inviteLink" readonly type="text"
                        class="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white border border-gray-200 dark:border-transparent focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-300 text-center font-mono text-sm"
                        @click="$event.target.select()">
                </div>

                <div class="flex flex-col space-y-3">
                    <button @click="copyInviteLink"
                        class="w-full py-3 bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 text-white font-black rounded-xl shadow-lg hover:shadow-blue-500/20 transition-all active:scale-95 uppercase tracking-widest text-sm">
                        {{ linkCopied ? 'âœ“ Copied!' : 'Copy Link' }}
                    </button>
                    <button @click="closeInviteModal"
                        class="w-full py-3 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 font-bold rounded-xl transition-colors uppercase tracking-widest text-sm">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <!-- Leave Confirmation Modal -->
        <div v-if="showLeaveModal"
            class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-gray-900/40 dark:bg-black/80 backdrop-blur-md">
            <div
                class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl p-8 max-w-sm w-full border border-gray-100 dark:border-gray-700 text-center animate-slide-in">
                <div class="mb-4 text-red-500 dark:text-red-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="text-2xl font-black mb-2 text-gray-900 dark:text-white uppercase tracking-tight">End Session?
                </h3>
                <p class="text-gray-600 dark:text-gray-300 mb-8 font-medium italic">
                    As the host, leaving will close this room for all players.
                </p>
                <div class="flex flex-col space-y-3">
                    <button @click="confirmHostLeave"
                        class="w-full py-4 bg-red-500 hover:bg-red-600 text-white font-black rounded-xl shadow-lg hover:shadow-red-500/20 transition-all active:scale-95 uppercase tracking-widest text-sm">
                        LEAVE & CLOSE ROOM
                    </button>
                    <button @click="showLeaveModal = false"
                        class="w-full py-4 text-gray-500 dark:text-gray-400 font-bold hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl transition-all uppercase tracking-widest text-sm">
                        STAY IN GAME
                    </button>
                </div>
            </div>
        </div>

        <!-- Player Leave During Game Modal -->
        <div v-if="showPlayerLeaveModal"
            class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-gray-900/40 dark:bg-black/80 backdrop-blur-md">
            <div
                class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl p-8 max-w-sm w-full border border-gray-100 dark:border-gray-700 text-center animate-slide-in">
                <div class="mb-4 text-orange-500 dark:text-orange-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="text-2xl font-black mb-2 text-gray-900 dark:text-white uppercase tracking-tight">Leave Game?
                </h3>
                <p class="text-gray-600 dark:text-gray-300 mb-8 font-medium italic">
                    You will be unable to reconnect to this game once you leave. Are you sure?
                </p>
                <div class="flex flex-col space-y-3">
                    <button @click="confirmPlayerLeave"
                        class="w-full py-4 bg-orange-500 hover:bg-orange-600 text-white font-black rounded-xl shadow-lg hover:shadow-orange-500/20 transition-all active:scale-95 uppercase tracking-widest text-sm">
                        LEAVE GAME
                    </button>
                    <button @click="showPlayerLeaveModal = false"
                        class="w-full py-4 text-gray-500 dark:text-gray-400 font-bold hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl transition-all uppercase tracking-widest text-sm">
                        STAY IN GAME
                    </button>
                </div>
            </div>
        </div>

        <!-- Notifications Overlay -->
        <div class="fixed bottom-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none">
            <transition-group name="notification">
                <div v-for="note in notifications" :key="note.id"
                    class="pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-xl shadow-2xl border backdrop-blur-md min-w-[300px] max-w-sm"
                    :class="note.type === 'error' ? 'bg-red-500/90 border-red-400 text-white' : note.type === 'warning' ? 'bg-orange-500/90 border-orange-400 text-white' : 'bg-green-500/90 border-green-400 text-white'">
                    <span v-if="note.type === 'error'" class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </span>
                    <span v-else-if="note.type === 'warning'" class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.464-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414" />
                        </svg>
                    </span>
                    <span v-else class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </span>
                    <p class="font-bold text-sm">{{ note.message }}</p>
                    <button @click="removeNotification(note.id)" class="ml-auto hover:opacity-70 transition-opacity">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </transition-group>
        </div>

    </div>


    <script src="/static/app.js"></script>
    <style>
        @keyframes slide-in {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-in {
            animation: slide-in 0.5s ease forwards;
        }

        .fill-animation {
            width: 0%;
            transition: width 0.5s ease-out;
        }

        /* Results List Reordering Animation */
        .results-list-move {
            transition: transform 0.4s ease;
        }

        /* Notification Animations */
        .notification-enter-active,
        .notification-leave-active {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .notification-enter-from {
            opacity: 0;
            transform: translateX(100%) scale(0.9);
        }

        .notification-leave-to {
            opacity: 0;
            transform: translateX(10%) scale(0.9);
        }

        /* Shake Animation */
        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            10%,
            30%,
            50%,
            70%,
            90% {
                transform: translateX(-5px);
            }

            20%,
            40%,
            60%,
            80% {
                transform: translateX(5px);
            }
        }

        .shake-error {
            animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both;
        }

        .success-border {
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.5);
        }

        /* Player List Shake Animation */
        @keyframes player-shake {
            0%, 100% {
                transform: translateX(0);
            }
            10%, 30%, 50%, 70%, 90% {
                transform: translateX(-3px);
            }
            20%, 40%, 60%, 80% {
                transform: translateX(3px);
            }
        }

        .animate-player-shake {
            animation: player-shake 0.4s cubic-bezier(.36, .07, .19, .97) both;
        }

        /* Dynamic color button sizing */
        .drawing-toolbar-inner {
            --total-buttons: 10; /* 9 colors + 1 eraser */
            --gap-size: 0.25rem; /* gap-1 = 0.25rem */
        }

        .color-palette-grid {
            /* Calculate button size based on this container's actual width */
            --button-size: min(2.5rem, calc((100% - var(--gap-size) * (var(--total-buttons) - 1)) / var(--total-buttons)));
        }

        .color-btn {
            width: var(--button-size);
            height: var(--button-size);
            min-width: 1.3rem;
            min-height: 1.3rem;
            max-width: 2.5rem;
            max-height: 2.5rem;
            border-radius: 0.375rem !important; /* rounded-lg - smaller radius to keep square shape on small buttons */
        }

        /* Action buttons (undo/clear) - JavaScript will set inline styles to match color buttons */
        .drawing-actions-group .color-btn {
            /* Size will be set by JavaScript syncButtonSizes() */
            aspect-ratio: 1;
            max-width: 2.5rem;
            max-height: 2.5rem;
        }

        /* On very small screens, allow wrapping */
        @media (max-width: 320px) {
            .color-palette-grid {
                flex-wrap: wrap;
            }
        }
    </style>
</body>

</html>