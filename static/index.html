<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Party Games Service</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Base backgrounds that transition */
        body {
            background-color: #f9fafb;
            /* gray-50 */
            color: #111827;
            /* gray-900 */
            transition: background-color 0.3s, color 0.3s;
        }

        .dark body {
            background-color: #111827;
            /* gray-900 */
            color: #ffffff;
        }

        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.3s;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        @keyframes pulse-subtle {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.8;
                transform: scale(1.05);
            }
        }

        .animate-pulse-subtle {
            animation: pulse-subtle 3s infinite ease-in-out;
        }

        @keyframes bounce-subtle {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        .animate-bounce-subtle {
            animation: bounce-subtle 2s infinite ease-in-out;
        }
    </style>
</head>

<body :class="{ 'dark': isDarkMode }">
    <div id="app"
        class="min-h-screen flex flex-col items-center p-0 sm:p-4 bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
        <header class="w-full max-w-4xl flex justify-between items-center mb-6 sm:mb-10 mt-4 sm:mt-6 px-4 sm:px-2">
            <div class="flex items-center gap-3 sm:gap-4 overflow-visible">
                <img src="/static/logo_wide.svg" alt="Party Games"
                    class="block h-10 sm:h-12 w-auto drop-shadow-[0_2px_8px_rgba(234,81,40,0.35)]">
            </div>
            <div class="flex items-center gap-2 sm:gap-4">
                <button @click="toggleTheme"
                    class="relative inline-flex h-6 w-11 sm:h-8 sm:w-14 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none bg-gray-200 dark:bg-gray-700 shadow-inner group"
                    :title="isDarkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'">
                    <span class="sr-only">Toggle theme</span>
                    <span aria-hidden="true" :class="isDarkMode ? 'translate-x-5 sm:translate-x-6' : 'translate-x-0'"
                        class="pointer-events-none flex items-center justify-center h-5 w-5 sm:h-7 sm:w-7 transform rounded-full bg-white dark:bg-gray-900 shadow-lg ring-0 transition duration-200 ease-in-out">
                        <!-- Sun icon -->
                        <svg v-if="!isDarkMode" xmlns="http://www.w3.org/2000/svg"
                            class="h-3 w-3 sm:h-4 sm:w-4 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M10 1a1 1 0 011 1v1a1 1 0 11-2 0V2a1 1 0 011-1zm4.243 1.757a1 1 0 010 1.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 0zM19 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zm-4.757 4.243a1 1 0 01-1.414 0l-.707-.707a1 1 0 111.414-1.414l.707.707a1 1 0 010 1.414zM10 19a1 1 0 01-1-1v-1a1 1 0 112 0v1a1 1 0 01-1 1zm-4.243-1.757a1 1 0 010-1.414l.707-.707a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414 0zM1 10a1 1 0 011-1h1a1 1 0 110 2H2a1 1 0 01-1-1zm1.757-4.243a1 1 0 011.414 0l.707.707a1 1 0 11-1.414 1.414l-.707-.707a1 1 0 010-1.414zM10 14a4 4 0 100-8 4 4 0 000 8z"
                                clip-rule="evenodd" />
                        </svg>
                        <!-- Moon icon -->
                        <svg v-else xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 sm:h-4 sm:w-4 text-blue-400"
                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                    </span>
                </button>
                <div v-if="nickname"
                    class="text-xs sm:text-base text-gray-600 dark:text-gray-300 flex items-center gap-1.5 sm:gap-2">
                    <template v-if="isEditingNickname && view === 'lobby'">
                        <input v-model="nicknameInput" @keyup.enter="saveNickname" @keyup.esc="cancelEditingNickname"
                            type="text"
                            class="text-sm px-2 py-1 rounded bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white border border-[#ea5128] focus:outline-none w-32">
                        <div class="flex items-center gap-1">
                            <button @click="saveNickname" class="text-green-500 hover:text-green-600 p-0.5">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                            <button @click="cancelEditingNickname" class="text-red-500 hover:text-red-600 p-0.5">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </template>
                    <template v-else>
                        <span class="whitespace-nowrap">Playing as:</span>
                        <div class="flex items-center gap-1">
                            <span
                                class="font-bold text-gray-900 dark:text-white truncate max-w-[100px] sm:max-w-none">{{
                                nickname }}</span>
                            <button v-if="view === 'lobby'" @click="startEditingNickname"
                                class="text-gray-400 hover:text-[#ea5128] transition-colors p-1 -m-1"
                                title="Edit Nickname">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 sm:h-4 sm:w-4"
                                    viewBox="0 0 20 20" fill="currentColor">
                                    <path
                                        d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                </svg>
                            </button>
                        </div>
                    </template>
                </div>
            </div>
        </header>

        <!-- View: Login -->
        <transition name="fade" mode="out-in">
            <div v-if="view === 'login'"
                class="bg-white dark:bg-gray-800 p-10 rounded-3xl shadow-2xl w-full max-w-lg flex flex-col items-center border border-gray-200 dark:border-gray-700/50 transition-colors duration-300">
                <img src="/static/logo.svg" alt="Logo"
                    class="h-24 w-auto mb-8 drop-shadow-[0_8px_20px_rgba(234,81,40,0.25)] animate-pulse-subtle">
                <h2 class="text-3xl mb-8 font-black w-full text-center text-gray-900 dark:text-gray-100">Enter Nickname
                </h2>
                <input v-model="nicknameInput" @keyup.enter="setNickname" type="text"
                    placeholder="Your cool nickname..."
                    class="w-full p-3 rounded bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-[#ea5128] mb-4 transition-colors duration-300">
                <button @click="setNickname"
                    class="w-full bg-[#ea5128] hover:bg-[#c1381b] text-white font-bold py-3 rounded-xl transition shadow-lg hover:shadow-xl active:scale-95">Enter
                    Lobby</button>
            </div>

            <!-- View: Lobby -->
            <div v-else-if="view === 'lobby'"
                class="w-full max-w-4xl px-4 sm:px-0 grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-8">
                <!-- Room List -->
                <div
                    class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 transition-colors duration-300">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-black text-gray-900 dark:text-gray-100">Open Rooms</h2>
                        <button @click="fetchRooms"
                            class="text-sm text-[#ea5128] hover:text-[#ff6e4a] font-bold transition-colors">Refresh</button>
                    </div>
                    <div v-if="rooms.length === 0"
                        class="text-gray-400 dark:text-gray-500 text-center py-8 bg-gray-50 dark:bg-gray-700/30 rounded-xl border border-dashed border-gray-200 dark:border-gray-700">
                        No rooms found. Create one!
                    </div>
                    <ul v-else class="space-y-2">
                        <li v-for="room in rooms" :key="room.id"
                            class="flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 p-3 rounded-xl border border-gray-100 dark:border-transparent hover:border-[#ea5128] dark:hover:bg-gray-700 transition-all">
                            <div>
                                <span class="font-bold text-gray-800 dark:text-gray-200">{{ room.name }}</span>
                                <span v-if="room.has_password" class="ml-2 text-xs text-yellow-500">üîí</span>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="text-xs sm:text-sm text-gray-500 dark:text-gray-400">{{ room.players_count
                                    }} active</span>
                                <button @click="joinRoom(room.id)"
                                    class="bg-[#ea5128] hover:bg-[#c1381b] px-4 py-1.5 rounded-lg text-sm text-white font-bold transition-all shadow-md active:scale-95">Join</button>
                            </div>
                        </li>
                    </ul>
                </div>

                <!-- Create Room -->
                <div
                    class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl h-fit border border-gray-200 dark:border-gray-700 transition-colors duration-300">
                    <h2 class="text-xl font-black text-gray-900 dark:text-gray-100 mb-4">Create Room</h2>
                    <input v-model="newRoomName" type="text" placeholder="Room Name"
                        class="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white mb-3 border border-gray-200 dark:border-transparent focus:outline-none focus:ring-2 focus:ring-[#ea5128] transition-colors duration-300">
                    <input v-model="newRoomPassword" type="text" placeholder="Password (Optional)"
                        class="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white mb-4 border border-gray-200 dark:border-transparent focus:outline-none focus:ring-2 focus:ring-[#ea5128] transition-colors duration-300">

                    <label class="block text-gray-500 dark:text-gray-400 text-sm mb-1 font-bold">Game Mode</label>
                    <select v-model="selectedGameType"
                        class="w-full p-3 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white mb-6 border border-gray-200 dark:border-transparent focus:outline-none focus:ring-2 focus:ring-[#ea5128] transition-colors duration-300">
                        <option value="drawing">Drawing Guesser</option>
                    </select>

                    <button @click="createRoom"
                        class="w-full bg-[#ea5128] hover:bg-[#c1381b] text-white font-black py-4 rounded-xl transition-all shadow-lg hover:shadow-[#ea512833] active:scale-95">Create
                        & Join Room</button>
                </div>
            </div>

            <!-- View: Room (Game) -->
            <div v-else-if="view === 'room'" class="w-full max-w-6xl">
                <div class="mb-4 sm:mb-6 flex justify-between items-center">
                    <button @click="leaveRoom"
                        class="text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors flex items-center gap-2 font-bold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
                                clip-rule="evenodd" />
                        </svg>
                        Leave Room
                    </button>
                    <div class="flex gap-4">
                        <div v-if="gameState === 'lobby'" class="flex gap-4">
                            <button @click="toggleReady"
                                :class="amIReady ? 'bg-gray-400 dark:bg-gray-600 hover:bg-gray-500' : 'bg-[#ea5128] hover:bg-[#c1381b]'"
                                class="px-6 py-2 rounded-xl font-black text-white transition-all shadow-md active:scale-95">
                                {{ amIReady ? 'Unready' : 'Ready' }}
                            </button>
                            <button v-if="amIHost" @click="startGame" :disabled="!canStart"
                                :class="canStart ? 'bg-yellow-500 hover:bg-yellow-400 text-black' : 'bg-gray-200 dark:bg-gray-700 text-gray-400 dark:text-gray-500 cursor-not-allowed'"
                                class="px-6 py-2 rounded-xl font-black transition-all shadow-md">
                                Start Game
                            </button>
                        </div>
                        <div v-else class="text-[#ea5128] font-black text-xl animate-pulse tracking-widest uppercase">
                            Live!
                        </div>
                    </div>
                </div>
                <div class="flex flex-col lg:grid lg:grid-cols-4 gap-2 sm:gap-4 lg:h-[600px]">
                    <!-- Sidebar: Players -->
                    <div
                        class="order-3 lg:order-none bg-white dark:bg-gray-800 p-2 sm:p-4 rounded-2xl col-span-1 overflow-y-auto max-h-[200px] lg:max-h-none border border-gray-200 dark:border-gray-700 shadow-xl transition-colors duration-300">
                        <h3
                            class="font-black mb-3 text-gray-400 dark:text-gray-500 uppercase text-[10px] tracking-widest">
                            Players ({{ players.length }})</h3>
                        <ul class="space-y-2">
                            <li v-for="p in players" :key="p.nickname"
                                class="flex items-center justify-between bg-gray-50 dark:bg-gray-700 p-2 rounded-xl transition-colors duration-300">
                                <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm text-white relative shadow-md"
                                        :style="{backgroundColor: p.color}">
                                        {{ p.nickname[0] }}
                                        <span v-if="p.is_host" class="absolute -top-1 -right-1 text-xs">üëë</span>
                                    </div>
                                    <span class="truncate max-w-[100px] font-bold" :style="{color: p.color}">{{
                                        p.nickname
                                        }}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-sm font-black text-yellow-500">{{ p.score || 0 }}</span>
                                    <span v-if="p.is_ready" class="text-green-500 text-xl">‚úì</span>
                                </div>
                            </li>
                        </ul>
                    </div>

                    <!-- Main: Game Area (Canvas/Config placeholder) -->
                    <div
                        class="order-1 lg:order-none bg-white dark:bg-gray-900 rounded-none sm:rounded-2xl col-span-2 flex flex-col items-center justify-center border-0 sm:border border-gray-200 dark:border-gray-700 relative p-0 sm:p-8 lg:p-6 shadow-xl transition-colors duration-300">
                        <div v-if="gameState === 'lobby'" class="w-full max-w-md p-4 sm:p-0">
                            <h3 class="text-2xl font-black mb-6 text-center text-[#ea5128] uppercase tracking-wider">
                                Settings</h3>

                            <div class="space-y-6">
                                <!-- Round Duration -->
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <label
                                            class="text-gray-600 dark:text-gray-400 font-bold uppercase text-xs tracking-widest">Round
                                            Duration</label>
                                        <span class="text-[#ea5128] font-black">{{ gameConfig.round_duration }}s</span>
                                    </div>
                                    <input type="range" min="30" max="180" step="10"
                                        v-model.number="gameConfig.round_duration" @input="updateConfig"
                                        :disabled="!amIHost"
                                        class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer accent-[#ea5128]">
                                </div>

                                <!-- Points to Win -->
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <label
                                            class="text-gray-600 dark:text-gray-400 font-bold uppercase text-xs tracking-widest">Points
                                            to Win</label>
                                        <span class="text-[#ea5128] font-black">{{ gameConfig.points_to_win }}</span>
                                    </div>
                                    <input type="range" min="5" max="250" step="5"
                                        v-model.number="gameConfig.points_to_win" @input="updateConfig"
                                        :disabled="!amIHost"
                                        class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer accent-[#ea5128]">
                                </div>

                                <!-- Base Points -->
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <label
                                            class="text-gray-600 dark:text-gray-400 font-bold uppercase text-xs tracking-widest">Base
                                            Points (First Guess)</label>
                                        <span class="text-[#ea5128] font-black">{{ gameConfig.base_points || 10
                                            }}</span>
                                    </div>
                                    <input type="range" min="1" :max="gameConfig.points_to_win" step="1"
                                        v-model.number="gameConfig.base_points" @input="updateConfig"
                                        :disabled="!amIHost"
                                        class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer accent-[#ea5128]">
                                </div>

                                <!-- Turn Order -->
                                <div>
                                    <label
                                        class="block text-gray-600 dark:text-gray-400 font-bold uppercase text-xs tracking-widest mb-2">Turn
                                        Order</label>
                                    <div class="flex gap-4">
                                        <button @click="setTurnOrder('sequence')" :disabled="!amIHost"
                                            :class="gameConfig.turn_order === 'sequence' ? 'bg-[#ea5128] text-white shadow-[#ea512833]' : 'bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 border border-transparent'"
                                            class="flex-1 py-3 rounded-xl transition-all border border-transparent shadow-lg active:scale-95 font-bold">
                                            Sequential
                                        </button>
                                        <button @click="setTurnOrder('winner')" :disabled="!amIHost"
                                            :class="gameConfig.turn_order === 'winner' ? 'bg-[#ea5128] text-white shadow-[#ea512833]' : 'bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 border border-transparent'"
                                            class="flex-1 py-3 rounded-xl transition-all border border-transparent shadow-lg active:scale-95 font-bold">
                                            Winner First
                                        </button>
                                    </div>
                                </div>

                                <!-- Word Language -->
                                <div>
                                    <label
                                        class="block text-gray-600 dark:text-gray-400 font-bold uppercase text-xs tracking-widest mb-2">Word
                                        Language</label>
                                    <select v-model="gameConfig.word_language" @change="updateConfig"
                                        :disabled="!amIHost"
                                        class="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white border border-gray-200 dark:border-transparent focus:outline-none focus:ring-2 focus:ring-[#ea5128] transition-colors duration-300">
                                        <option value="English">English</option>
                                        <option value="Ukrainian">Ukrainian</option>
                                    </select>
                                </div>

                                <!-- Host Plays -->
                                <div class="flex items-center justify-between">
                                    <label
                                        class="text-gray-600 dark:text-gray-400 font-bold uppercase text-xs tracking-widest">Host
                                        Plays</label>
                                    <button @click="toggleHostPlays" :disabled="!amIHost" type="button"
                                        class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-[#ea5128] focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-gray-900"
                                        :class="[gameConfig.host_plays ? 'bg-[#ea5128]' : 'bg-gray-200 dark:bg-gray-700', !amIHost ? 'cursor-not-allowed opacity-50' : '']">
                                        <span class="sr-only">Use setting</span>
                                        <span aria-hidden="true"
                                            :class="gameConfig.host_plays ? 'translate-x-5' : 'translate-x-0'"
                                            class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                                    </button>
                                </div>
                            </div>

                            <p v-if="!amIHost" class="mt-8 text-center text-gray-500 text-sm italic">Only the host can
                                change settings.</p>
                        </div>

                        <div v-else class="w-full h-full flex flex-col relative text-gray-900 dark:text-white">
                            <!-- Top Bar: Info -->
                            <div class="flex justify-between items-center mb-1 px-1 sm:px-2">
                                <div class="text-[10px] sm:text-xs">
                                    <span
                                        class="text-gray-400 dark:text-gray-500 uppercase font-black tracking-widest">Round</span>
                                    <span class="font-black ml-1 text-gray-700 dark:text-white">{{ gameStateData.round
                                        }}</span>
                                </div>
                                <div class="text-xl sm:text-3xl font-black font-mono"
                                    :class="timeLeft < 10 && gameStateData.phase === 'DRAWING' ? 'text-red-500' : 'text-gray-900 dark:text-white'">
                                    {{ gameStateData.phase === 'DRAWING' ? timeLeft + 's' : (gameStateData.phase ===
                                    'DRAWER_PREPARING' ? 'READY?' : '') }}
                                </div>
                                <div class="text-[10px] sm:text-xs text-right">
                                    <div v-if="gameStateData.phase === 'DRAWING'">
                                        <span
                                            class="text-gray-400 dark:text-gray-500 uppercase font-black tracking-widest">Drawer:</span>
                                        <span class="text-yellow-600 dark:text-yellow-400 font-black ml-1">{{
                                            gameStateData.drawer }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Word Display -->
                            <div class="mb-2 sm:mb-6 text-center">
                                <h2 v-if="amIDrawing"
                                    class="text-2xl sm:text-4xl font-black text-green-600 dark:text-green-400 tracking-wider">
                                    {{ gameStateData.word }}</h2>
                                <h2 v-else
                                    class="text-2xl sm:text-4xl font-black text-gray-700 dark:text-gray-300 tracking-[0.3em] sm:tracking-[0.5em]">
                                    {{ gameStateData.word_hints }}</h2>
                                <p v-if="amIDrawing"
                                    class="text-[10px] sm:text-xs text-gray-400 dark:text-gray-500 font-bold uppercase tracking-widest mt-1">
                                    You are drawing!</p>
                                <p v-else
                                    class="text-[10px] sm:text-xs text-gray-400 dark:text-gray-500 font-bold uppercase tracking-widest mt-1">
                                    Guess the word!</p>
                            </div>

                            <!-- START ROUND BUTTON (DRAWER ONLY) -->
                            <div v-if="amIDrawing && gameStateData.phase === 'DRAWER_PREPARING'"
                                class="absolute inset-0 z-20 flex items-center justify-center bg-black/40 rounded-lg">
                                <button @click="startActiveRound"
                                    class="bg-green-600 hover:bg-green-500 text-white text-2xl font-bold py-6 px-12 rounded-xl shadow-2xl transform hover:scale-105 transition-all">
                                    START ROUND!
                                </button>
                            </div>

                            <!-- Canvas Area -->
                            <div class="w-full aspect-[4/3] relative bg-white rounded-xl shadow-2xl overflow-hidden border border-gray-100 dark:border-gray-800"
                                id="canvas-container">
                                <canvas ref="gameCanvas"
                                    class="w-full h-full block cursor-crosshair touch-none"></canvas>
                            </div>

                            <!-- Drawing Toolbar (Drawer Only) -->
                            <div v-if="amIDrawing && gameStateData.phase !== 'POST_ROUND' && gameStateData.phase !== 'GAME_OVER'"
                                class="mt-2 sm:mt-4 bg-white dark:bg-gray-800 p-2 sm:p-3 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-2xl flex items-center justify-between gap-4 max-w-full overflow-hidden transition-colors duration-300">

                                <!-- Color Palette (First) -->
                                <div class="flex flex-wrap sm:flex-nowrap gap-2 sm:gap-3 justify-center flex-1 min-w-0">
                                    <template v-for="c in drawColors" :key="c">
                                        <button @click="setBrushColor(c)" :style="{backgroundColor: c}"
                                            class="w-6 h-6 sm:w-8 sm:h-8 rounded-full border-2 border-white dark:border-gray-900 hover:scale-125 transition-all shrink-0 shadow-lg active:scale-90"
                                            :class="{'ring-4 ring-[#ea5128]': currentBrushColor === c}"></button>
                                    </template>
                                </div>

                                <!-- Drawing Actions (Second) -->
                                <div
                                    class="flex items-center gap-2 pl-4 border-l border-gray-100 dark:border-gray-700 shrink-0">
                                    <button @click="undoStroke" title="Undo last stroke"
                                        class="w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-xl text-white transition-all active:scale-90 shadow-lg">
                                        <span class="text-lg">‚Ü©Ô∏è</span>
                                    </button>
                                    <button @click="clearCanvas" title="Clear all drawings"
                                        class="w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-xl text-white transition-all active:scale-90 shadow-lg">
                                        <span class="text-lg">üóëÔ∏è</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar: Chat -->
                    <div
                        class="order-2 lg:order-none bg-white dark:bg-gray-800 p-2 sm:p-4 rounded-2xl col-span-1 flex flex-col h-[250px] lg:h-[600px] mt-0 border border-gray-200 dark:border-gray-700 shadow-xl transition-colors duration-300">
                        <h3
                            class="font-black mb-3 text-gray-400 dark:text-gray-500 uppercase text-[10px] tracking-widest">
                            Chat</h3>
                        <div class="flex-1 overflow-y-auto bg-gray-50 dark:bg-gray-900/50 rounded-xl p-3 mb-3 space-y-2 border border-gray-100 dark:border-transparent shadow-inner"
                            id="chat-box">
                            <div v-for="(msg, i) in messages" :key="i" class="text-sm">
                                <span :style="{color: msg.color}" class="font-black">{{ msg.sender }}:</span>
                                <span class="text-gray-700 dark:text-gray-200 ml-1 font-medium">{{ msg.text }}</span>
                            </div>
                        </div>
                        <input v-model="chatInput" @keyup.enter="sendChat" type="text"
                            :disabled="(amIDrawing && gameStateData.phase === 'DRAWING') || (hasGuessed && gameStateData.phase === 'DRAWING')"
                            :placeholder="amIDrawing ? 'You are drawing...' : (hasGuessed ? 'You guessed correctly!' : 'Type a guess...')"
                            class="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white border border-gray-200 dark:border-transparent focus:outline-none focus:ring-2 focus:ring-[#ea5128] disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300">
                    </div>
                </div>

                <!-- Overlay: Round End / Game Over (Fixed Full-Screen) -->
                <div v-if="gameStateData.phase === 'POST_ROUND' || gameStateData.phase === 'GAME_OVER'"
                    class="fixed inset-0 bg-gray-900/40 dark:bg-black/80 backdrop-blur-md flex flex-col items-center justify-center z-[60] text-center p-4">
                    <h2
                        class="text-5xl font-black text-gray-900 dark:text-white mb-2 drop-shadow-lg uppercase tracking-tighter">
                        {{ gameStateData.phase ===
                        'GAME_OVER' ?
                        'GAME OVER!' : 'Round Over!' }}</h2>
                    <p class="text-xl text-gray-600 dark:text-gray-300 mb-6 font-bold uppercase tracking-widest">The
                        word was: <span class="text-green-600 dark:text-green-400 font-black">{{
                            gameStateData.word }}</span></p>

                    <div
                        class="bg-white dark:bg-gray-800 p-8 rounded-3xl w-full max-w-sm shadow-2xl border border-gray-100 dark:border-gray-700">
                        <div v-if="sortedPlayers.length > 0"
                            class="mb-8 text-center bg-yellow-50 dark:bg-yellow-500/10 p-4 rounded-2xl border-2 border-yellow-200 dark:border-yellow-500/20">
                            <div
                                class="text-[10px] text-yellow-600 dark:text-yellow-400 font-black uppercase tracking-widest mb-1">
                                Winner
                            </div>
                            <div
                                class="text-4xl font-black text-yellow-600 dark:text-yellow-400 flex items-center justify-center gap-3">
                                <span>üèÜ</span> {{ sortedPlayers[0].nickname }}
                            </div>
                            <div class="text-gray-700 dark:text-white font-black mt-1 text-xl">{{ sortedPlayers[0].score
                                }} pts</div>
                        </div>

                        <h3
                            class="text-gray-400 dark:text-gray-500 text-[10px] font-black uppercase tracking-widest mb-4">
                            Leaderboard</h3>
                        <ul class="space-y-2">
                            <li v-for="(p, idx) in sortedPlayers" :key="p.nickname"
                                class="flex justify-between items-center p-3 rounded-xl bg-gray-50 dark:bg-gray-700/50 border border-transparent"
                                :class="idx === 0 ? 'border-yellow-500/50 bg-yellow-50/50 dark:bg-gray-700/80' : ''">
                                <div class="flex items-center gap-3">
                                    <span class="font-mono text-gray-400 dark:text-gray-500 w-4 text-right font-bold">{{
                                        idx + 1
                                        }}</span>
                                    <span
                                        :class="idx === 0 ? 'font-black text-gray-900 dark:text-white' : 'text-gray-700 dark:text-gray-300 font-bold'">{{
                                        p.nickname }}</span>
                                </div>
                                <span class="font-black"
                                    :class="idx === 0 ? 'text-yellow-600 dark:text-yellow-400' : 'text-gray-400 dark:text-gray-400'">{{
                                    p.score
                                    }}</span>
                            </li>
                        </ul>
                        <button v-if="amIHost" @click="startGame"
                            class="mt-8 w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl shadow-xl hover:shadow-blue-500/20 transition-all active:scale-95 text-lg">
                            Play Again
                        </button>
                    </div>
                </div>

                <!-- Results Modal -->
                <div v-if="gameStateData.phase === 'DRAWER_PREPARING'"
                    class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900/40 dark:bg-black/80 backdrop-blur-md p-4">
                    <div
                        class="bg-white dark:bg-gray-800 w-full max-w-2xl rounded-3xl shadow-2xl border border-gray-100 dark:border-gray-700 overflow-hidden transform transition-all">
                        <div
                            class="p-6 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-900/50">
                            <div>
                                <h2 class="text-2xl font-black text-gray-900 dark:text-white uppercase tracking-wider">
                                    Next Up: <span class="text-[#ea5128]">{{ gameStateData.drawer }}</span>
                                </h2>
                                <p v-if="gameStateData.last_drawer"
                                    class="text-[#ea5128] text-sm font-bold flex items-center gap-1">
                                    <span class="text-gray-500 dark:text-gray-400">{{ gameStateData.last_drawer
                                        }}</span> was drawing
                                    <span
                                        class="text-gray-900 dark:text-white uppercase tracking-widest px-2 py-0.5 bg-gray-100 dark:bg-gray-700 rounded">{{
                                        gameStateData.last_word }}</span>
                                </p>
                            </div>
                        </div>

                        <div class="p-6 space-y-4 max-h-[50vh] overflow-y-auto bg-white dark:bg-gray-800">
                            <transition-group name="results-list" tag="div" class="space-y-4">
                                <div v-for="(res, idx) in animatedResults" :key="res.nickname"
                                    class="relative flex items-center gap-4 p-4 bg-gray-50 dark:bg-gray-700/40 rounded-2xl border-2 transition-all duration-500 animate-slide-in"
                                    :class="res.nickname === gameStateData.last_drawer ? 'border-yellow-500/50 shadow-lg' : 'border-transparent'"
                                    :style="{ animationDelay: (idx * 0.1) + 's' }">

                                    <div class="w-12 h-12 rounded-full flex-shrink-0 flex items-center justify-center text-xl font-black text-white shadow-xl relative"
                                        :style="{ backgroundColor: getPlayerColor(res.nickname) }">
                                        {{ res.nickname[0] }}
                                        <!-- Rank Badge -->
                                        <div v-if="getRank(res.nickname)"
                                            class="absolute -top-2 -left-2 w-6 h-6 bg-yellow-500 rounded-full flex items-center justify-center text-[10px] text-black font-black border-2 border-white dark:border-gray-800 shadow-md">
                                            #{{ getRank(res.nickname) }}
                                        </div>
                                    </div>

                                    <div class="flex-1">
                                        <div class="flex justify-between items-end mb-1">
                                            <span class="font-black text-gray-800 dark:text-gray-200 text-lg">{{
                                                res.nickname }} <span v-if="res.nickname === gameStateData.last_drawer"
                                                    class="text-xs text-[#ea5128] italic font-bold">(Drawer)</span></span>
                                            <span
                                                class="text-green-600 dark:text-green-400 font-black text-2xl animate-pulse">+{{
                                                res.points
                                                }}</span>
                                        </div>
                                        <div
                                            class="relative h-4 w-full bg-gray-200 dark:bg-gray-900 rounded-full overflow-hidden flex shadow-inner">
                                            <!-- Base Score Segment -->
                                            <div class="h-full bg-[#ea5128]/60 transition-all duration-1000 ease-out"
                                                :style="{ width: getBaseScorePercentage(res.nickname) + '%' }"></div>
                                            <!-- New Points Segment -->
                                            <div class="h-full bg-[#ea5128] transition-all duration-1000 ease-out fill-animation border-l border-white/20"
                                                :style="{ width: getNewPointsPercentage(res.nickname) + '%' }"></div>
                                        </div>
                                        <div class="flex justify-between mt-1 pt-1">
                                            <span
                                                class="text-xs text-gray-500 dark:text-gray-400 font-black uppercase tracking-widest">Total:
                                                <span class="text-gray-900 dark:text-white">{{
                                                    getBaseScore(res.nickname) +
                                                    res.points }}</span></span>
                                            <span v-if="res.nickname === gameStateData.last_drawer"
                                                class="text-[10px] text-gray-400 italic">
                                                guessed in {{ res.time }}s
                                            </span>
                                            <span v-else-if="res.time"
                                                class="text-[10px] text-gray-400 italic font-bold">Guessed in
                                                {{
                                                res.time }}s</span>
                                        </div>
                                    </div>
                                </div>
                            </transition-group>
                        </div>

                        <div class="p-8 bg-gray-50 dark:bg-gray-900/50 text-center flex flex-col items-center gap-6">
                            <p v-if="gameStateData.phase === 'DRAWER_PREPARING' && amIDrawing"
                                class="text-gray-600 dark:text-gray-400 text-xs font-black uppercase tracking-[0.2em] mb-[-1rem]">
                                Your word is
                            </p>
                            <div v-if="gameStateData.phase === 'DRAWER_PREPARING' && amIDrawing"
                                class="text-4xl font-black text-[#ea5128] uppercase tracking-tighter mb-2">
                                {{ gameStateData.word }}
                            </div>

                            <div v-if="gameStateData.phase === 'DRAWER_PREPARING'" class="w-full">
                                <template v-if="amIDrawing">
                                    <button @click="startActiveRound"
                                        class="w-full py-5 bg-green-600 hover:bg-green-500 text-white rounded-2xl font-black text-2xl shadow-xl hover:shadow-green-500/20 transition-all animate-bounce-subtle">
                                        START ROUND!
                                    </button>
                                </template>
                                <template v-else>
                                    <div
                                        class="flex items-center justify-center gap-4 py-4 text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-lg">
                                        <svg class="animate-spin h-6 w-6 text-[#ea5128]"
                                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                                stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor"
                                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                            </path>
                                        </svg>
                                        <span class="font-black uppercase tracking-widest text-sm">Wait for <span
                                                class="text-[#ea5128]">{{
                                                gameStateData.drawer }}</span></span>
                                    </div>
                                </template>
                            </div>
                            <div v-else class="text-gray-500 text-xs font-black uppercase tracking-[0.3em]">Preparing...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    view: 'login', // login, lobby, room
                    nickname: '',
                    nicknameInput: '',
                    isEditingNickname: false,

                    // Lobby
                    rooms: [],
                    newRoomName: '',
                    newRoomPassword: '',
                    selectedGameType: 'drawing',

                    // Room / Game
                    currentRoomId: null,
                    socket: null,
                    players: [],
                    messages: [],
                    chatInput: '',
                    clientId: Math.random().toString(36).substr(2, 9),
                    gameState: 'lobby', // lobby, playing
                    gameConfig: {
                        round_duration: 60,
                        points_to_win: 50,
                        base_points: 10,
                        turn_order: 'sequence',
                        points_to_win: 50,
                        base_points: 10,
                        turn_order: 'sequence',
                        host_plays: true,
                        word_language: 'English'
                    },
                    configTimeout: null,

                    // Game State
                    gameStateData: {
                        round: 0,
                        drawer: null,
                        phase: 'PRE_ROUND',
                        timer_end: 0,
                        time_left: 0,
                        word: '',
                        word_hints: '',
                        scores: {},
                        correct_guessers: []
                    },
                    timeLeft: 0,
                    localTimerEnd: 0,
                    timerInterval: null,

                    // Canvas
                    ctx: null,
                    isDrawing: false,
                    lastX: 0,
                    lastY: 0,
                    currentBrushColor: '#000000',
                    drawColors: ['#000000', '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', '#FFFFFF', '#8B4513', '#FFA500'],
                    strokeHistory: [],
                    currentActionId: null,
                    // Animation & Results
                    animatedResults: [],
                    lastTurnResults: {},
                    resultsScores: {}, // Local scoreboard for animation
                    isDarkMode: true // Default to dark mode
                }
            },
            computed: {
                amIHost() {
                    const p = this.players.find(p => p.nickname === this.nickname);
                    return p ? p.is_host : false;
                },
                amIReady() {
                    const p = this.players.find(p => p.nickname === this.nickname);
                    return p ? p.is_ready : false;
                },
                canStart() {
                    if (this.players.length < 2) return false;
                    const hostPlays = this.gameConfig.host_plays;
                    const playing = this.players.filter(p => !p.is_host || hostPlays);
                    // Need at least 2 playing players? Or just 2 total connections?
                    // Server check: need 2 playing players.
                    // If Host Spectates: Need 2 OTHER players.
                    // If Host Plays: Need 1 OTHER player (Total 2).
                    // This visual check is approx, server is authority.
                    return this.players.every(p => p.is_ready);
                },
                amIDrawing() {
                    return this.gameStateData.drawer === this.nickname;
                },
                hasGuessed() {
                    return this.gameStateData.correct_guessers && this.gameStateData.correct_guessers.includes(this.nickname);
                },
                sortedPlayers() {
                    return [...this.players].sort((a, b) => b.score - a.score);
                }
            },
            watch: {
                gameState(newVal) {
                    if (newVal === 'playing') {
                        this.$nextTick(() => {
                            this.initCanvas();
                        });
                    }
                },
                'gameConfig.points_to_win'(newVal) {
                    if (this.gameConfig.base_points > newVal) {
                        this.gameConfig.base_points = newVal;
                        this.updateConfig();
                    }
                },
                'gameStateData.phase'(newVal, oldVal) {
                    if (newVal === 'DRAWER_PREPARING' && oldVal !== 'DRAWER_PREPARING') {
                        this.startResultsAnimation();
                    } else if (newVal !== 'DRAWER_PREPARING') {
                        this.animatedResults = [];
                    }
                }
            },
            mounted() {
                window.addEventListener('resize', this.handleResize);
                const savedNick = localStorage.getItem('nickname');
                const savedRoom = localStorage.getItem('roomId');
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme) {
                    this.isDarkMode = savedTheme === 'dark';
                } else {
                    // Default to system preference if no saved theme
                    this.isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
                }
                this.updateThemeClass();

                if (savedNick) {
                    this.nickname = savedNick;
                    if (savedRoom) {
                        this.view = 'room';
                        this.currentRoomId = savedRoom;
                        this.connectWebSocket();
                    } else {
                        this.view = 'lobby';
                        this.fetchRooms();
                    }
                }
            },
            methods: {
                setNickname() {
                    if (!this.nicknameInput.trim()) return;
                    this.nickname = this.nicknameInput.trim();
                    localStorage.setItem('nickname', this.nickname);
                    this.view = 'lobby';
                    this.fetchRooms();
                },
                startEditingNickname() {
                    this.nicknameInput = this.nickname;
                    this.isEditingNickname = true;
                },
                saveNickname() {
                    const newNick = this.nicknameInput.trim();
                    if (newNick && newNick !== this.nickname) {
                        this.nickname = newNick;
                        localStorage.setItem('nickname', this.nickname);
                    }
                    this.isEditingNickname = false;
                },
                cancelEditingNickname() {
                    this.isEditingNickname = false;
                },
                async fetchRooms() {
                    try {
                        const res = await fetch('/api/rooms');
                        this.rooms = await res.json();
                    } catch (e) { console.error("Failed to fetch rooms", e); }
                },
                async createRoom() {
                    if (!this.newRoomName.trim()) return;
                    try {
                        const res = await fetch('/api/rooms', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: this.newRoomName,
                                password: this.newRoomPassword || null,
                                game_type: this.selectedGameType,
                                config: this.gameConfig
                            })
                        });
                        const data = await res.json();
                        this.joinRoom(data.room_id);
                    } catch (e) { console.error("Failed to create room", e); }
                },
                joinRoom(roomId) {
                    this.currentRoomId = roomId;
                    localStorage.setItem('roomId', roomId);
                    this.view = 'room';
                    this.connectWebSocket();
                },
                leaveRoom() {
                    if (this.socket) {
                        this.socket.close();
                        this.socket = null;
                    }
                    this.currentRoomId = null;
                    localStorage.removeItem('roomId');
                    this.players = [];
                    this.messages = [];
                    this.gameState = 'lobby';
                    this.view = 'lobby';
                    this.fetchRooms();
                },
                toggleReady() {
                    if (!this.socket) return;
                    this.socket.send(JSON.stringify({
                        type: "TOGGLE_READY",
                        payload: { is_ready: !this.amIReady }
                    }));
                },
                startGame() {
                    if (!this.socket) return;
                    this.socket.send(JSON.stringify({
                        type: "START_GAME",
                        payload: {}
                    }));
                },
                startActiveRound() {
                    if (!this.socket) return;
                    this.socket.send(JSON.stringify({
                        type: "START_ROUND",
                        payload: {}
                    }));
                },
                setTurnOrder(order) {
                    if (!this.amIHost) return;
                    this.gameConfig.turn_order = order;
                    this.updateConfig();
                },
                toggleHostPlays() {
                    if (!this.amIHost) return;
                    this.gameConfig.host_plays = !this.gameConfig.host_plays;
                    this.updateConfig();
                },
                updateConfig() {
                    if (!this.amIHost || !this.socket) return;
                    if (this.configTimeout) clearTimeout(this.configTimeout);
                    this.configTimeout = setTimeout(() => {
                        this.socket.send(JSON.stringify({
                            type: "UPDATE_CONFIG",
                            payload: { config: this.gameConfig }
                        }));
                    }, 300);
                },
                toggleTheme() {
                    this.isDarkMode = !this.isDarkMode;
                    localStorage.setItem('theme', this.isDarkMode ? 'dark' : 'light');
                    this.updateThemeClass();
                },
                updateThemeClass() {
                    if (this.isDarkMode) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                },

                // --- Canvas ---
                initCanvas() {
                    const canvas = this.$refs.gameCanvas;
                    if (!canvas) {
                        // Retry shortly if the ref isn't available yet
                        setTimeout(() => this.initCanvas(), 50);
                        return;
                    }

                    // Use a high-quality fixed internal resolution for consistent coordinate mapping
                    canvas.width = 2000;
                    canvas.height = 1500;

                    this.ctx = canvas.getContext('2d');
                    this.ctx.lineCap = 'round';
                    this.ctx.lineJoin = 'round';
                    this.ctx.lineWidth = 15;

                    // Mouse
                    canvas.addEventListener('mousedown', this.startDrawing);
                    canvas.addEventListener('mousemove', this.draw);
                    canvas.addEventListener('mouseup', this.stopDrawing);
                    canvas.addEventListener('mouseout', this.stopDrawing);

                    // Touch
                    canvas.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        const touch = e.touches[0];
                        const mouseEvent = new MouseEvent('mousedown', {
                            clientX: touch.clientX,
                            clientY: touch.clientY
                        });
                        canvas.dispatchEvent(mouseEvent);
                    }, { passive: false });
                    canvas.addEventListener('touchmove', (e) => {
                        e.preventDefault();
                        const touch = e.touches[0];
                        const mouseEvent = new MouseEvent('mousemove', {
                            clientX: touch.clientX,
                            clientY: touch.clientY
                        });
                        canvas.dispatchEvent(mouseEvent);
                    }, { passive: false });
                    canvas.addEventListener('touchend', () => {
                        const mouseEvent = new MouseEvent('mouseup', {});
                        canvas.dispatchEvent(mouseEvent);
                    });

                    // Redraw if we already have history (e.g. from a sync message that arrived before init)
                    if (this.strokeHistory.length > 0) {
                        this.redrawFromHistory(this.strokeHistory);
                    }
                },
                getPos(e) {
                    const canvas = this.$refs.gameCanvas;
                    const rect = canvas.getBoundingClientRect();
                    // Crucial: Use current display dimensions (rect) to calculate fraction,
                    // not the internal resolution (canvas.width/height).
                    return {
                        x: (e.clientX - rect.left) / rect.width,
                        y: (e.clientY - rect.top) / rect.height
                    };
                },
                startDrawing(e) {
                    if (!this.amIDrawing) return;
                    this.isDrawing = true;
                    this.currentActionId = Math.random().toString(36).substr(2, 9);
                    const pos = this.getPos(e);
                    this.lastX = pos.x;
                    this.lastY = pos.y;
                },
                draw(e) {
                    if (!this.isDrawing || !this.amIDrawing) return;
                    const pos = this.getPos(e);

                    // Local Draw
                    this.drawStroke(this.lastX, this.lastY, pos.x, pos.y, this.currentBrushColor);

                    // Server Send
                    this.socket.send(JSON.stringify({
                        type: "DRAW_STROKE",
                        payload: {
                            x1: this.lastX, y1: this.lastY,
                            x2: pos.x, y2: pos.y,
                            color: this.currentBrushColor,
                            actionId: this.currentActionId
                        }
                    }));

                    this.lastX = pos.x;
                    this.lastY = pos.y;
                },
                stopDrawing() {
                    this.isDrawing = false;
                },
                drawStroke(x1, y1, x2, y2, color, fromHistory = false) {
                    if (!this.ctx) {
                        if (fromHistory) {
                            // If drawing from history and ctx isn't ready, 
                            // it will be picked up by initCanvas once it runs.
                        }
                        return;
                    }
                    const w = this.$refs.gameCanvas.width;
                    const h = this.$refs.gameCanvas.height;
                    this.ctx.beginPath();
                    this.ctx.moveTo(x1 * w, y1 * h);
                    this.ctx.lineTo(x2 * w, y2 * h);
                    this.ctx.strokeStyle = color;
                    this.ctx.lineWidth = 15; // Ensure width is consistent
                    this.ctx.stroke();

                    if (!fromHistory) {
                        this.strokeHistory.push({ x1, y1, x2, y2, color });
                    }
                },
                setBrushColor(c) {
                    this.currentBrushColor = c;
                },
                undoStroke() {
                    if (!this.amIDrawing || !this.socket) return;
                    this.socket.send(JSON.stringify({ type: "UNDO_STROKE", payload: {} }));
                },
                clearCanvas() {
                    if (!this.amIDrawing) return;
                    this.performClear();
                    this.socket.send(JSON.stringify({ type: "CLEAR_CANVAS", payload: {} }));
                },
                performClear() {
                    this.clearPixels();
                    this.strokeHistory = [];
                },
                clearPixels() {
                    if (!this.ctx) return;
                    this.ctx.clearRect(0, 0, this.$refs.gameCanvas.width, this.$refs.gameCanvas.height);
                },
                handleResize() {
                    if (this.gameState === 'playing' && this.$refs.gameCanvas) {
                        this.redrawFromHistory(this.strokeHistory);
                    }
                },
                redrawFromHistory(history) {
                    this.clearPixels();
                    if (!history) return;
                    history.forEach(stroke => {
                        this.drawStroke(stroke.x1, stroke.y1, stroke.x2, stroke.y2, stroke.color, true);
                    });
                },

                // --- Connection ---
                connectWebSocket() {
                    const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
                    const wsUrl = `${protocol}://${window.location.host}/ws/${this.currentRoomId}/${this.clientId}`;
                    this.socket = new WebSocket(wsUrl);

                    this.socket.onopen = () => {
                        this.socket.send(JSON.stringify({
                            type: "JOIN",
                            payload: { nickname: this.nickname }
                        }));
                    };

                    this.socket.onmessage = (event) => {
                        const msg = JSON.parse(event.data);
                        this.handleMessage(msg);
                    };

                    this.socket.onclose = () => { console.log("Disconnected"); };
                },
                startResultsAnimation() {
                    const results = this.lastTurnResults;
                    const players = [...this.players];

                    // Initialize results scores with the values BEFORE adding points
                    players.forEach(p => {
                        const delta = results[p.nickname] ? results[p.nickname].points : 0;
                        this.resultsScores[p.nickname] = p.score - delta;
                    });

                    this.animatedResults = [];
                    const sortedNicks = Object.keys(results).sort((a, b) => {
                        // Guessers first by time, then drawer
                        if (a === this.gameStateData.drawer) return 1;
                        if (b === this.gameStateData.drawer) return -1;
                        return results[a].time - results[b].time;
                    });

                    let i = 0;
                    const interval = setInterval(() => {
                        if (i >= sortedNicks.length) {
                            clearInterval(interval);

                            // Re-sort results list for the ranking update
                            setTimeout(() => {
                                this.animatedResults.sort((a, b) => {
                                    const totalA = this.getBaseScore(a.nickname) + a.points;
                                    const totalB = this.getBaseScore(b.nickname) + b.points;
                                    return totalB - totalA;
                                });
                                // Also re-sort main sidebar leaderboard
                                this.players.sort((a, b) => b.score - a.score);
                            }, 1000);
                            return;
                        }
                        const nick = sortedNicks[i];
                        this.animatedResults.push({
                            nickname: nick,
                            ...results[nick]
                        });
                        i++;
                    }, 800);
                },
                getPlayerColor(nickname) {
                    const p = this.players.find(p => p.nickname === nickname);
                    return p ? p.color : '#7C3AED';
                },
                getBaseScore(nickname) {
                    return this.resultsScores[nickname] || 0;
                },
                getBaseScorePercentage(nickname) {
                    const base = this.getBaseScore(nickname);
                    const max = this.gameConfig.points_to_win || 50;
                    return (base / max) * 100;
                },
                getNewPointsPercentage(nickname) {
                    const pts = this.lastTurnResults[nickname]?.points || 0;
                    const max = this.gameConfig.points_to_win || 50;
                    return (pts / max) * 100;
                },
                getRank(nickname) {
                    // Calculate rank based on animatedResults current order (after they are all sorted)
                    const sorted = [...this.animatedResults].sort((a, b) => {
                        const totalA = this.getBaseScore(a.nickname) + a.points;
                        const totalB = this.getBaseScore(b.nickname) + b.points;
                        return totalB - totalA;
                    });
                    const idx = sorted.findIndex(r => r.nickname === nickname);
                    return idx !== -1 ? idx + 1 : null;
                },
                handleMessage(msg) {
                    console.log("Received:", msg);
                    if (msg.type === "JOIN_SUCCESS") {
                        this.players = msg.payload.players;
                        this.gameState = msg.payload.state || 'lobby';
                        if (msg.payload.config) this.gameConfig = { ...this.gameConfig, ...msg.payload.config };
                        this.messages.push({ sender: "System", text: `Joined room. Welcome!` });

                        if (this.gameState === 'playing') {
                            // Re-join running game? Request state? 
                            // Wait for next game_state_update...
                        }
                    } else if (msg.type === "PLAYER_JOINED") {
                        this.messages.push({ sender: "System", text: `${msg.payload.nickname} joined.`, color: '#aaaaaa' });
                        if (!this.players.find(p => p.nickname === msg.payload.nickname)) {
                            this.players.push({
                                nickname: msg.payload.nickname,
                                is_ready: msg.payload.is_ready,
                                is_host: false,
                                color: msg.payload.color || '#ffffff'
                            });
                        }
                    } else if (msg.type === "PLAYER_UPDATE") {
                        const p = this.players.find(p => p.nickname === msg.payload.nickname);
                        if (p) {
                            p.is_ready = msg.payload.is_ready;
                        }
                    } else if (msg.type === "CONFIG_UPDATE") {
                        this.gameConfig = { ...this.gameConfig, ...msg.payload.config };
                    } else if (msg.type === "GAME_STATE_UPDATE") {
                        this.gameState = 'playing';
                        const oldPhase = this.gameStateData.phase;
                        this.gameStateData = msg.payload.game_state;
                        this.lastTurnResults = msg.payload.turn_results || {};

                        // Score Sync
                        for (const [nick, score] of Object.entries(msg.payload.scores)) {
                            const p = this.players.find(p => p.nickname === nick);
                            if (p) p.score = score;
                        }

                        // Timer Sync
                        if (msg.payload.game_state.timer_end > 0) {
                            this.localTimerEnd = msg.payload.game_state.timer_end;
                        } else {
                            this.localTimerEnd = 0;
                        }

                        if (this.timerInterval) clearInterval(this.timerInterval);
                        this.updateTimer();
                        this.timerInterval = setInterval(this.updateTimer, 1000);

                        // Canvas Init & Clears
                        this.$nextTick(() => {
                            if (!this.ctx) this.initCanvas();
                            if (msg.payload.game_state.phase === 'PRE_ROUND' || msg.payload.game_state.phase === 'DRAWER_PREPARING') this.performClear();
                        });
                    } else if (msg.type === "DRAW_STROKE") {
                        const p = msg.payload;
                        this.drawStroke(p.x1, p.y1, p.x2, p.y2, p.color);
                    } else if (msg.type === "STROKE_HISTORY_UPDATE") {
                        console.log("STROKE_HISTORY_UPDATE", msg.payload.history);
                        this.strokeHistory = msg.payload.history;
                        this.redrawFromHistory(this.strokeHistory);
                    } else if (msg.type === "CLEAR_CANVAS") {
                        this.performClear();
                    } else if (msg.type === "PLAYER_DISCONNECTED") {
                        this.messages.push({ sender: "System", text: `${msg.payload.nickname} disconnected.` });
                    } else if (msg.type === "PLAYER_LEFT") {
                        const idx = this.players.findIndex(p => p.nickname === msg.payload.nickname);
                        if (idx !== -1) this.players.splice(idx, 1);
                        this.messages.push({ sender: "System", text: `${msg.payload.nickname} left the room.` });
                    } else if (msg.type === "CHAT") {
                        this.messages.push(msg.payload);
                        this.$nextTick(() => {
                            const el = document.getElementById('chat-box');
                            if (el) el.scrollTop = el.scrollHeight;
                        });
                    } else if (msg.type === "ERROR") {
                        alert(msg.payload.message);
                        if (msg.payload.message.includes("taken")) {
                            this.leaveRoom();
                        }
                    }
                },
                updateTimer() {
                    const now = Date.now() / 1000;
                    this.timeLeft = Math.max(0, Math.floor(this.localTimerEnd - now));
                    if (this.timeLeft === 0 && this.timerInterval) clearInterval(this.timerInterval);
                },
                sendChat() {
                    if (!this.chatInput.trim() || !this.socket) return;
                    this.socket.send(JSON.stringify({
                        type: "CHAT",
                        payload: { text: this.chatInput }
                    }));
                    this.chatInput = '';
                }
            }
        }).mount('#app')
    </script>
    <style>
        @keyframes slide-in {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-in {
            animation: slide-in 0.5s ease forwards;
        }

        .fill-animation {
            width: 0%;
            transition: width 1s ease-out;
        }

        @keyframes bounce-subtle {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-3px);
            }
        }

        .animate-bounce-subtle {
            animation: bounce-subtle 2s infinite ease-in-out;
        }

        /* Results List Reordering Animation */
        .results-list-move {
            transition: transform 0.8s ease;
        }
    </style>
</body>

</html>